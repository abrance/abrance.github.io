
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>sc-core.md | Xiaoy</title>
    <meta name="author" content="xiaoy" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>XIAOY</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;XIAOY</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>sc-core.md</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/4/19
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/sr/" style="color: #ffa2c4">
                    sr
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>sc-core 是 sc 的通信组件，提供：</p>
<ul>
<li>建立总控-引擎连接通道</li>
<li>通过通道发送信息</li>
</ul>
<p>的能力，它是一个 grpc server ，需要建立通道的组件都是 grpc client。</p>
<h2 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h2><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ul>
<li>部署问题：防火墙策略开放不合理；将之前 总控-&gt;引擎 这种开放策略改为 引擎-&gt;总控。原因详见通信链路相关机制讲解</li>
<li>链路繁杂问题：之前组件负责人各自进行开发，没有站在系统角度考虑问题，导致链路过多，通信混乱，增加了复杂度</li>
</ul>
<h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><ul>
<li>使用 sc-core 作为通用通信组件，将防火墙策略问题解决了，即通信建立的方向为 引擎-&gt;总控。</li>
<li>客户端连接 sc-core 建立通信通道，将多条链路整合为了一条，降低了系统复杂度。</li>
</ul>
<h2 id="架构实现"><a href="#架构实现" class="headerlink" title="架构实现"></a>架构实现</h2><h3 id="主要原理"><a href="#主要原理" class="headerlink" title="主要原理"></a>主要原理</h3><ul>
<li>grpc 双向通信 （通道建立）</li>
<li>TLS （安全认证）</li>
<li>grpc streamInterceptor</li>
</ul>
<p><img src="/sc-core-arch.png" alt="img.png"></p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="基础库"><a href="#基础库" class="headerlink" title="基础库"></a>基础库</h4><h5 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h5><h6 id="core-message"><a href="#core-message" class="headerlink" title="core_message"></a>core_message</h6><p>core_message 是 sc-core 传输消息的协议</p>
<pre><code class="protobuf">// 元数据
message Metadata &#123;
  message Info &#123;
    // 引擎
    protobuf.common.v1.Engine engine = 1;
    // 节点
    protobuf.common.v1.Node node = 2;
    // 组件标识
    string component = 3;
  &#125;
  // 消息来源
  Info src = 1;
  // 消息目标
  Info dst = 2;
&#125;

message CoreMessage &#123;
  // 消息标识
  uint64 messageId = 1;

  Metadata metadata = 2;
  // 消息内容
  oneof message &#123;
    // 定义请求消息
    Request request = 4;
    // 定义响应消息
    Response response = 5;
  &#125;
  // 消息过期时间
  int64 expiredTime = 6;

  string version = 7;

  // 消息头
  map&lt;string, string&gt; headers = 9;

  // 消息序号
  uint64 Seq = 10;
&#125;
</code></pre>
<h6 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h6><pre><code class="protobuf">enum Method &#123;
  GET = 0;
  POST = 1;
  PUT = 2;
  DELETE = 3;
  PATCH = 4;
  LIST = 5;
&#125;

// 请求消息结构
message Request &#123;
  // 资源标识地址
  string url = 1;
  // 资源操作类型
  string method = 2;
  // 请求消息体
  bytes body = 3;
  // 请求参数
  map&lt;string, string&gt; params = 4;
&#125;
</code></pre>
<h6 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h6><pre><code class="protobuf">// 响应消息结构
message Response &#123;
  enum Code &#123;
    SUCCESS_CODE = 0;
    FAIL_CODE = 1;
  &#125;
  Code code = 1;
  bytes body = 2;
  string error = 3;
&#125;
</code></pre>
<h6 id="service-stream"><a href="#service-stream" class="headerlink" title="service stream"></a>service stream</h6><pre><code class="protobuf">service CoreService &#123;
  rpc Agent (stream protobuf.common.v1.CoreMessage) returns (stream protobuf.common.v1.CoreMessage)&#123;&#125;
&#125;
</code></pre>
<h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="容器测试"><a href="#容器测试" class="headerlink" title="容器测试"></a>容器测试</h3><h4 id="容器测试1"><a href="#容器测试1" class="headerlink" title="容器测试1"></a>容器测试1</h4><pre><code class="bash">docker build -t core .

docker run -d -p 20111:20111 --name core core
</code></pre>
<h4 id="容器测试2"><a href="#容器测试2" class="headerlink" title="容器测试2"></a>容器测试2</h4><p>Ubuntu20.04 安装</p>
<pre><code class="bash">docker build -f test/install/Dockerfile -t ubuntu-sc-core .

docker run -d -p 20111:20111 --privileged --name ubuntu-sc-core -v /sys/fs/cgroup:/sys/fs/cgroup:ro  -v /run/dbus/system_bus_socket:/run/dbus/system_bus_socket:ro -v /run/dbus:/run/dbus  --cap-add SYS_ADMIN ubuntu-sc-core &amp;&amp; docker exec ubuntu-sc-core systemctl start install.service
# 调试
# docker run -it -p 20111:20111 ubuntu-sc-core /bin/bash
</code></pre>
<h4 id="容器测试3"><a href="#容器测试3" class="headerlink" title="容器测试3"></a>容器测试3</h4><pre><code class="bash">docker build -f test/e2e/Dockerfile -t core-client .

# 本地测试
docker run --rm --net=host -e ADDR=127.0.0.1 -e LOOP=500 core-client

# 远程测试
docker run --rm -e ADDR=172.16.1.216 -e LOOP=500 core-client
</code></pre>
<h3 id="Makefile-执行-test"><a href="#Makefile-执行-test" class="headerlink" title="Makefile 执行 test"></a>Makefile 执行 test</h3><pre><code class="bash">make test-e2e
</code></pre>
<h2 id="异常梳理"><a href="#异常梳理" class="headerlink" title="异常梳理"></a>异常梳理</h2><h3 id="hosts-问题"><a href="#hosts-问题" class="headerlink" title="hosts 问题"></a>hosts 问题</h3><p>这个问题特征是sc core 找不到 客户端注册 信息，但是接收到 从客户端来的 request, 所以会返回给 客户端 503 找不到对端， 通过 ss 命令找到连到其他 sc ip 了<br>在 测试环境容易遇到，客户环境不太可能出现，遇到了可以立马查看 &#x2F;etc&#x2F;hosts，或者清理后重试</p>
<h3 id="对端问题"><a href="#对端问题" class="headerlink" title="对端问题"></a>对端问题</h3><p>对端退出</p>
<pre><code class="Text">2024/05/06 11:03:08 core client connection stop
2024/05/06 11:03:08 client handle recv ctx done
2024/05/06 11:03:08 rpc err:  rpc error: code = Canceled desc = grpc: the client connection is closing
2024/05/06 11:03:08 core client handle receive error rpc error: code = Canceled desc = grpc: the client connection is closing
2024/05/06 11:03:13 request: request timeout
panic: request timeout
</code></pre>
<h3 id="调试时出现"><a href="#调试时出现" class="headerlink" title="调试时出现"></a>调试时出现</h3><pre><code class="Text">2024/05/06 15:59:57 server is currently unavailable:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 15:59:57 rpc err:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 15:59:57 core client handle receive error rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 15:59:57 start client server err: rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 15:59:57 core client connection close error: rpc error: code = Canceled desc = grpc: the client connection is closing
2024/05/06 15:59:57 core client connection stop
2024/05/06 15:59:58 server is currently unavailable:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 15:59:58 rpc err:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 15:59:58 request: connect interrupted
2024/05/06 15:59:58 core client handle receive error rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 15:59:58 start err:  rpc error: code = Unavailable desc = error reading from server: EOF
panic: start client server err: rpc error: code = Unavailable desc = error reading from server: EOF



2024/05/06 16:27:29 server is currently unavailable:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:27:30 rpc err:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:27:30 server is currently unavailable:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:27:30 rpc err:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:27:30 request: message send fail:[EOF]
2024/05/06 16:27:30 core client handle receive error rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:27:30 start err:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:27:30 server is currently unavailable:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:27:30 core client handle receive error rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:27:30 start client server err: rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:27:30 rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:27:30 server is currently unavailable:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:27:33 message send fail:[EOF]
2024/05/06 16:27:35 request chan delete user/info
2024/05/06 16:27:35 request: message send fail:[EOF]
2024/05/06 16:27:37 connect err:  context deadline exceeded
2024/05/06 16:27:37 message send fail:[EOF]
panic: context deadline exceeded



2024/05/06 16:23:32 server is currently unavailable:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:23:32 rpc err:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:23:32 core client handle receive error rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:23:32 start err:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:23:32 server is currently unavailable:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:23:32 server is currently unavailable:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:23:32 rpc err:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:23:32 core client handle receive error rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:23:32 start err:  rpc error: code = Unavailable desc = error reading from server: EOF
2024/05/06 16:23:33 server is currently unavailable:  rpc error: code = Unavailable desc = error reading from server: EOF
panic: rpc error: code = Unavailable desc = error reading from server: EOF
</code></pre>
<h3 id="未知问题"><a href="#未知问题" class="headerlink" title="未知问题"></a>未知问题</h3><pre><code class="Text">rpc error: code = Unavailable desc = error reading from server: EOF
</code></pre>
<pre><code class="Text">dlv --listen=:2345 --headless=true --api-version=2 --accept-multiclient exec ./client dlv --listen=:2345 --headless=true --api-version=2 --accept-multiclient exec ./client -case base.simple -addr 127.0.0.1 -loop 100
</code></pre>
<pre><code class="Text"># 调试构建
go build -gcflags &quot;all=-N -l&quot; -o client cmd/client/main.go


# 调试运行
dlv --listen=:2345 --headless=true --api-version=2 --accept-multiclient exec ./client -- -case base.simple -addr 127.0.0.1 -loop 100
</code></pre>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 Xiaoy
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;xiaoy
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
