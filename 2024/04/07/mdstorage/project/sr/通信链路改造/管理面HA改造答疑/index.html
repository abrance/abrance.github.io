
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>管理面HA改造答疑.md | Xiaoy</title>
    <meta name="author" content="xiaoy" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>XIAOY</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;XIAOY</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>管理面HA改造答疑.md</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/4/7
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/sr/" style="color: #ff7d73">
                    sr
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/ha/" style="color: #00a596">
                    ha
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h2 id="Keepalived-概述"><a href="#Keepalived-概述" class="headerlink" title="Keepalived 概述"></a>Keepalived 概述</h2><p>Keepalived 为 Linux 系统提供了负载均衡和高可用能力。负载均衡的能力来自 Linux 内核中的 LVS 项目模块 IPVS（IP Virtual Server）。</p>
<p>Keepalived 运行在 Linux 系统中，它会启动内核中的 LVS 服务来创建虚拟服务器。比如我们在两台服务器上都启动了一个 Keepalived 服务，然后 LVS 会虚拟化出来一个 IP（VIP），但是只有一个 Keepalived 会接管这个 VIP，就是说客户端的请求只会到 Master Keepalived 节点上。这样流量就只会到一台 keepalived 上了，然后 keepalived 可以配置几台真实的服务 IP 地址和端口，通过负载调度算法将流量分摊到这些服务上。对于另外一台 Backup Keepalived 节点，它是待机状态，没有流量接入的。</p>
<p>Keepalived 使用 C 语言编写的开源软件项目，项目的目的主要是简化 LVS 项目的配置并增强 LVS 的稳定性。简单来说，Keepalived 就是对 LVS 的扩展增强。管理面没有 LVS,所以管理面 HA 其实存在的意义不大。</p>
<pre><code class="mermaid">---
title: 部署视图
---

graph TD;
    subgraph LAN[&quot;局域网&quot;]
        switch[(&quot;交换机&quot;)]
    end
    subgraph Internet[&quot;互联网&quot;]
        userDevice1((&quot;用户设备1&quot;))
        userDevice2((&quot;用户设备2&quot;))
        router[(&quot;路由器&quot;)]
        userDevice1 --&gt; router
        userDevice2 --&gt; router
        router --&gt; switch
    end
    subgraph Servers[&quot;服务器集群&quot;]
        master[(&quot;主服务器&quot;)]
        backup1[(&quot;备份服务器1&quot;)]
        backup2[(&quot;备份服务器2&quot;)]
        switch --&gt; master
        switch --&gt; backup1
        switch --&gt; backup2
    end
    VIP((&quot;虚拟IP&quot;)) -.-&gt; master
    master -. &quot;故障转移&quot; .-&gt; backup1
    master -. &quot;故障转移&quot; .-&gt; backup2
    classDef default fill:#1E90FF,stroke:#333,stroke-width:2px;
    classDef network fill:#708090,stroke:#333,stroke-width:2px;
    class LAN,Internet,Servers network;
</code></pre>
<ul>
<li><strong>用户</strong>通过互联网访问服务，请求先到达路由器，然后通过交换机转发。</li>
<li><strong>主服务器</strong>拥有虚拟IP（VIP），作为对外服务的唯一入口点。</li>
<li><strong>备份服务器</strong>准备在主服务器发生故障时接管VIP，保证服务的持续可用性。</li>
<li><strong>虚拟IP（VIP）</strong>指向主服务器，但在需要时可以快速迁移到备份服务器。</li>
<li>故障转移的逻辑被表示为从主服务器指向备份服务器的箭头。</li>
</ul>
<pre><code class="mermaid">---
title: 故障转移视图
---
graph TD;
    subgraph Internet[&quot;互联网&quot;]
        userDevice1((&quot;用户设备1&quot;))
        userDevice2((&quot;用户设备2&quot;))
        router[(&quot;路由器&quot;)]
        userDevice1 --&gt;|请求服务| VIP
        userDevice2 --&gt;|请求服务| VIP
    end
    subgraph LAN[&quot;局域网&quot;]
        switch[(&quot;交换机&quot;)]
        VIP((&quot;虚拟IP&quot;)) --&gt; switch
    end
    subgraph Servers[&quot;服务器集群&quot;]
        master[(&quot;主服务器&quot;)]
        backup1[(&quot;备份服务器1&quot;)]
        backup2[(&quot;备份服务器2&quot;)]
        switch --&gt; master
        switch --&gt; backup1
        switch --&gt; backup2
    end
    VIP -. &quot;当前指向&quot; .-&gt; master
    master -. &quot;故障时转移至&quot; .-&gt; backup1
    backup1 -. &quot;故障时转移至&quot; .-&gt; backup2
    classDef default fill:#1E90FF,stroke:#333,stroke-width:2px;
    classDef network fill:#708090,stroke:#333,stroke-width:2px;
    class Internet,LAN,Servers network;
</code></pre>
<h3 id="Keepalived-在传统高可用架构下的位置"><a href="#Keepalived-在传统高可用架构下的位置" class="headerlink" title="Keepalived 在传统高可用架构下的位置"></a>Keepalived 在传统高可用架构下的位置</h3><pre><code class="mermaid">---
title: 传统高可用架构部署视图
---
graph TD;
    subgraph Internet[&quot;互联网&quot;]
        userDevice1((&quot;用户设备1&quot;))
        userDevice2((&quot;用户设备2&quot;))
        userDevice1 --&gt;|请求服务| VIP
        userDevice2 --&gt;|请求服务| VIP
    end
    subgraph LAN[&quot;局域网&quot;]
        switch[(&quot;交换机&quot;)]
        VIP((&quot;虚拟IP&quot;)) --&gt; switch
    end
    subgraph LB_Cluster[&quot;负载均衡器集群(LVS)&quot;]
        LVS_Master[(&quot;LVS 主节点&quot;)]
        LVS_Backup1[(&quot;LVS 备份节点1&quot;)]
        LVS_Backup2[(&quot;LVS 备份节点2&quot;)]
        switch --&gt; LVS_Master
        switch ----&gt; LVS_Backup1
        switch ----&gt; LVS_Backup2
    end
    subgraph Keepalived_Cluster[&quot;Keepalived 集群&quot;]
        Keepalived_Master[(&quot;Keepalived 主&quot;)]
        Keepalived_Backup1[(&quot;Keepalived 备份1&quot;)]
        Keepalived_Backup2[(&quot;Keepalived 备份2&quot;)]
        LVS_Master --&gt; Keepalived_Master
        LVS_Backup --&gt; Keepalived_Backup1
        LVS_Backup --&gt; Keepalived_Backup2
    end
    subgraph Backend_Servers[&quot;后端服务器&quot;]
        server1[(&quot;服务器1&quot;)]
        server2[(&quot;服务器2&quot;)]
        server3[(&quot;服务器3&quot;)]
        LVS_Master --&gt; server1
        LVS_Master --&gt; server2
        LVS_Master --&gt; server3
    end
    VIP -. &quot;当前指向&quot; .-&gt; LVS_Master
    LVS_Master -. &quot;故障时转移至&quot; .-&gt; LVS_Backup
    Keepalived_Master -. &quot;管理&quot; .-&gt; LVS_Master
    Keepalived_Backup1 -. &quot;备用管理&quot; .-&gt; LVS_Backup
    Keepalived_Backup2 -. &quot;备用管理&quot; .-&gt; LVS_Backup
    classDef default fill:#1E90FF,stroke:#333,stroke-width:2px;
    classDef network fill:#708090,stroke:#333,stroke-width:2px;
    class Internet,LAN,LB_Cluster,Keepalived_Cluster,Backend_Servers network;
</code></pre>
<ul>
<li><strong>用户设备</strong>通过互联网向虚拟IP（VIP）发送服务请求。</li>
<li><strong>虚拟IP（VIP）</strong>由Keepalived管理，并指向LVS的主节点。</li>
<li><strong>LVS的主节点</strong>和备份节点构成了负载均衡器集群，负责将请求分发到后端服务器。</li>
<li><strong>Keepalived集群</strong>包括主节点和备份节点，用于管理LVS集群的高可用性，确保在LVS主节点发生故障时能够将VIP快速迁移到备份节点。</li>
<li><strong>后端服务器</strong>接收来自LVS主节点的请求，并处理这些请求。</li>
</ul>
<h2 id="改造前引擎高可用机制数据流向"><a href="#改造前引擎高可用机制数据流向" class="headerlink" title="改造前引擎高可用机制数据流向"></a>改造前引擎高可用机制数据流向</h2><pre><code class="mermaid">---
title: 改造前引擎高可用机制数据流向
---
graph TD;
    subgraph Internet[&quot;互联网&quot;]
        userDevice1((&quot;客户设备1&quot;))
        userDevice2((&quot;客户设备2&quot;))
        router_public[(&quot;公网路由器|防火墙&quot;)]
        userDevice1 --&gt;|访问总控| router_public
        userDevice2 --&gt;|访问总控| router_public
    end
    subgraph PublicNetwork[&quot;公网可访问网络&quot;]
        switch_public[(&quot;公网交换机&quot;)]
        router_public --&gt; switch_public
    end
    subgraph SC[总控]
        sc[(sc)]
        sv[(sv)]
        switch_public --&gt; sc
    end
    subgraph DataCenter[&quot;数据中心网络&quot;]
        router_datacenter[(&quot;数据中心路由器|防火墙&quot;)]
        switch_datacenter[(&quot;数据中心交换机&quot;)]
        router_datacenter --&gt; switch_datacenter
    end
    subgraph SEM[管理面]
        VIP((虚拟IP))
        subgraph SEMNode1[管理面节点1]
            other_comp1[(管理面组件)]
        end
        subgraph SEMNode2[管理面节点2]
            other_comp2[(管理面组件)]
        end
        subgraph SEMNode3[管理面节点3]
            other_comp3[(管理面组件)]
        end
        subgraph KeepalivedSEM[管理面Keepalived]
            keepalived_master_SEM[(&quot;Keepalived 主&quot;)]
            keepalived_backup_SEM[(&quot;Keepalived 备份&quot;)]
            keepalived_master_SEM --&gt; keepalived_backup_SEM
            keepalived_backup_SEM -.-&gt; keepalived_master_SEM
        end
        other_comp1 &lt;--&gt;|服务搭建等管理工作| keepalived_master_SEM
        VIP -.-&gt; other_comp1 -. &quot;故障转移&quot; .-&gt; keepalived_backup_SEM
    end
    subgraph SES[调度集群]
        VIP_SES((业务VIP表))
        subgraph SES_LVS[调度LVS]
            LVS_SES_Master[(&quot;LVS 主节点&quot;)]
            lvs_policy((策略管理))
            LVS_SES_Backup[(&quot;LVS 备份节点&quot;)]
            LVS_SES_Master --&gt;|调度请求| LVS_SES_Backup
            LVS_SES_Backup -.-&gt;|故障转移| LVS_SES_Master
            LVS_SES_Master -.-&gt; lvs_policy
        end
        subgraph KeepalivedSES[调度Keepalived]
            keepalived_master_SES[(&quot;Keepalived 主&quot;)]
            keepalived_backup_SES[(&quot;Keepalived 备份&quot;)]
            keepalived_master_SES --&gt; keepalived_backup_SES
            keepalived_backup_SES -.-&gt; keepalived_master_SES
        end
        VIP_SES -.-&gt; LVS_SES_Master
        LVS_SES_Master --&gt; keepalived_master_SES
    end
    subgraph SEW[工作集群]
        subgraph Backend_Servers1[&quot;工作节点集群&quot;]
            envoy1[(&quot;Envoy&quot;)]
            polycuber1[(&quot;Polycuber&quot;)]
        end
        subgraph Backend_Servers2[&quot;工作节点集群&quot;]
            envoy2[(&quot;Envoy&quot;)]
            polycuber2[(&quot;Polycuber&quot;)]
        end
        subgraph Backend_Servers3[&quot;工作节点集群&quot;]
            envoy3[(&quot;Envoy&quot;)]
            polycuber3[(&quot;Polycuber&quot;)]
        end
    end

    subgraph UserServer[业务服务集群]
        subgraph ServerCluster1[&quot;业务服务集群1&quot;]
            node1[(node)]
            node2[(node)]
        end
        subgraph ServerCluster2[&quot;业务服务集群2&quot;]
            node3[(node)]
        end
        subgraph ServerCluster3[&quot;业务服务集群3&quot;]
            node4[(node)]
        end
    end
    subgraph UserSpace[&quot;用户|服务访问流量&quot;]
        user1((用户访问))
        frontend((前端业务))
    end
    other_comp1 --&gt; |管理| SES
    other_comp1 ---&gt; |管理| SEW

    LVS_SES_Master --业务流量转发--&gt; envoy1 &amp; envoy2 &amp; envoy3
    user1 &amp; frontend --&gt; VIP_SES
    envoy1 --&gt;|反向代理| node1 &amp; node2 &amp; node3
    envoy2 --&gt;|重定向| node4
    envoy3 &lt;--&gt;direct_response[直接响应] 
    switch_public --&gt;|接受来自SC的流量| router_datacenter
    switch_datacenter --&gt; VIP

    classDef network fill:#bbf,stroke:#333,stroke-width:2px;
    class Internet,PublicNetwork,DataCenter network;
    
    class Internet internet
    class PublicNetwork publicNet;
    class DataCenter dataCenter;
    class SEM management;
    class SES scheduling;
    class SEW workCluster;
    class UserServer userService;
    class UserSpace userAccess;
    classDef internet fill:#bde0fe,stroke:#333,stroke-width:2px;
    classDef publicNet fill:#fed7b2,stroke:#333,stroke-width:2px;
    classDef dataCenter fill:#d4a5a5,stroke:#333,stroke-width:4px;
    classDef management fill:#fbcfe8,stroke:#333,stroke-width:2px;
    classDef scheduling fill:#fef08a,stroke:#333,stroke-width:2px;
    classDef workCluster fill:#bbf7d0,stroke:#333,stroke-width:2px;
    classDef userService fill:#d9f99d,stroke:#333,stroke-width:2px;
    classDef userAccess fill:#a7f3d0,stroke:#333,stroke-width:2px;
    classDef flowLine stroke:#2563eb,stroke-width:2px,stroke-dasharray: 5, 5;
    linkStyle 3,4,17,18,29,30 stroke:#db2777,stroke-width:12px;
    linkStyle 19,20,21,22,23,24,25,26 stroke:#2563eb,stroke-width:2px,stroke-width:8px ;
</code></pre>
<h2 id="改造后引擎高可用机制数据流向"><a href="#改造后引擎高可用机制数据流向" class="headerlink" title="改造后引擎高可用机制数据流向"></a>改造后引擎高可用机制数据流向</h2><pre><code class="mermaid">---
title: 改造后引擎高可用机制数据流向
---
graph TD;
    subgraph Internet[&quot;互联网&quot;]
        userDevice1((&quot;客户设备1&quot;))
        userDevice2((&quot;客户设备2&quot;))
        router_public[(&quot;公网路由器|防火墙&quot;)]
        userDevice1 --&gt;|访问总控| router_public
        userDevice2 --&gt;|访问总控| router_public
    end
    subgraph PublicNetwork[&quot;公网可访问网络&quot;]
        switch_public[(&quot;公网交换机&quot;)]
        router_public --&gt; switch_public
    end
    subgraph SC[总控]
        sc_m_nic((管理口))
        sc[(sc)]
        sv[(sv)]
        sc_core[(sc-core)]
        switch_public &lt;-.-&gt; sc_m_nic --&gt; sc_core
        sc &amp; sv -.-&gt; sc_core
    end
    subgraph DataCenter[&quot;数据中心网络&quot;]
        router_datacenter[(&quot;数据中心路由器|防火墙&quot;)]
        switch_datacenter[(&quot;数据中心交换机&quot;)]
        router_datacenter &lt;-.-&gt; switch_datacenter
    end
    subgraph SEM[管理面]
        subgraph SEMNode1[管理面节点1]
            m_nic1((管理口))
            other_comp1[(管理面组件流量入口)]
            controller1[(管理面组件)]
            apiserver_node1[apiserver]
            m_nic1 &lt;-.-&gt; other_comp1
            other_comp1 --&gt; controller1 --&gt; apiserver_node1
        end
        subgraph SEMNode2[管理面节点2]
            m_nic2((管理口))
            other_comp2[(管理面组件流量入口)]
            controller2[(管理面组件)]
            apiserver_node2[apiserver]
            m_nic2 &lt;-.-&gt; other_comp2
            other_comp2 --&gt; controller2 --&gt; apiserver_node2
        end
        subgraph SEMNode3[管理面节点3]
            m_nic3((管理口))
            other_comp3[(管理面组件流量入口)]
            controller3[(管理面组件)]
            apiserver_node3[apiserver]
            m_nic3 &lt;-.-&gt; other_comp3
            other_comp3 --&gt; controller3 --&gt; apiserver_node3
        end
        subgraph Apiserver[Apiserver集群]
            apiserver1[(Apiserver)]
            apiserver2[(Apiserver)]
            apiserver3[(Apiserver)]
        end
        apiserver_node1 -.- apiserver1
        apiserver_node2 -.- apiserver2
        apiserver_node3 -.- apiserver3
    end
    subgraph SES[调度集群]
        VIP_SES((业务VIP表))
        subgraph SES_LVS[调度LVS]
            subgraph SESNode1
                ses_m_nic1((管理口))
                ses_d_nic1((业务口))
                LVS_SES_Master[(&quot;LVS 主节点&quot;)]
                lvs_policy((策略管理))
                ses_m_nic1 -.- lvs_policy
            end
            subgraph SESNode2
                ses_m_nic2((管理口))
                ses_d_nic2((业务口))
                LVS_SES_Backup[(&quot;LVS 备份节点&quot;)]
            end
            
            LVS_SES_Master --&gt;|调度请求| LVS_SES_Backup
            LVS_SES_Backup -.-&gt;|故障转移| LVS_SES_Master
            LVS_SES_Master -.-&gt; lvs_policy
        end
        subgraph KeepalivedSES[调度Keepalived]
            keepalived_master_SES[(&quot;Keepalived 主&quot;)]
            keepalived_backup_SES[(&quot;Keepalived 备份&quot;)]
            keepalived_master_SES --&gt; keepalived_backup_SES
            keepalived_backup_SES -.-&gt; keepalived_master_SES
        end
        VIP_SES -.- ses_d_nic1 --&gt; LVS_SES_Master
        LVS_SES_Master --&gt; keepalived_master_SES
    end
    subgraph SEW[工作集群]
        subgraph Backend_Servers1[&quot;工作节点集群&quot;]
            sew_m_nic1((管理口))
            sew_d_nic1((业务口))
            envoy1[(&quot;Envoy&quot;)]
            polycuber1[(&quot;Polycuber&quot;)]
            sew_m_nic1 &amp; sew_d_nic1 -.- envoy1
        end
        subgraph Backend_Servers2[&quot;工作节点集群&quot;]
            sew_m_nic2((管理口))
            sew_d_nic2((业务口))
            envoy2[(&quot;Envoy&quot;)]
            polycuber2[(&quot;Polycuber&quot;)]
            sew_m_nic2 &amp; sew_d_nic2 -.- envoy2
        end
        subgraph Backend_Servers3[&quot;工作节点集群&quot;]
            sew_m_nic3((管理口))
            sew_d_nic3((业务口))
            envoy3[(&quot;Envoy&quot;)]
            polycuber3[(&quot;Polycuber&quot;)]
            sew_m_nic3 &amp; sew_d_nic3 -.- envoy3
        end
    end

    subgraph UserServer[业务服务集群]
        subgraph ServerCluster1[&quot;业务服务集群1&quot;]
            node1[(node)]
            node2[(node)]
        end
        subgraph ServerCluster2[&quot;业务服务集群2&quot;]
            node3[(node)]
        end
        subgraph ServerCluster3[&quot;业务服务集群3&quot;]
            node4[(node)]
        end
    end
    subgraph UserSpace[&quot;用户|服务访问流量&quot;]
        user1((用户访问))
        frontend((前端业务))
    end
    ses_m_nic1 &amp; SEW ---&gt; Apiserver
    m_nic1 &amp; m_nic2 &amp; m_nic3 &lt;-.-&gt; switch_datacenter

    LVS_SES_Master --业务流量转发--&gt; sew_d_nic1 &amp; sew_d_nic2 &amp; sew_d_nic3
    user1 &amp; frontend --&gt; VIP_SES
    envoy1 --&gt;|反向代理| node1 &amp; node2 &amp; node3
    envoy2 --&gt;|重定向| node4
    envoy3 &lt;--&gt; direct_response[直接响应] 
    router_datacenter &lt;-.-&gt;|放通dst为sc的流| switch_public

    classDef network fill:#bbf,stroke:#333,stroke-width:2px;
    class Internet,PublicNetwork,DataCenter network;
    
    class Internet internet
    class PublicNetwork publicNet;
    class DataCenter dataCenter;
    class SEM management;
    class SES scheduling;
    class SEW workCluster;
    class UserServer userService;
    class UserSpace userAccess;
    classDef internet fill:#bde0fe,stroke:#333,stroke-width:2px;
    classDef publicNet fill:#fed7b2,stroke:#333,stroke-width:2px;
    classDef dataCenter fill:#d4a5a5,stroke:#333,stroke-width:4px;
    classDef management fill:#fbcfe8,stroke:#333,stroke-width:2px;
    classDef scheduling fill:#fef08a,stroke:#333,stroke-width:2px;
    classDef workCluster fill:#bbf7d0,stroke:#333,stroke-width:2px;
    classDef userService fill:#d9f99d,stroke:#333,stroke-width:2px;
    classDef userAccess fill:#a7f3d0,stroke:#333,stroke-width:2px;
    classDef flowLine stroke:#2563eb,stroke-width:2px,stroke-dasharray: 5, 5;
    linkStyle 0 stroke:#db2777,stroke-width:12px;
    linkStyle 0 stroke:#2563eb,stroke-width:2px,stroke-width:8px;
    linkStyle 0 stroke:#db2777,stroke-width:12px,color:red;
</code></pre>
<ul>
<li><strong>用户设备</strong>通过互联网访问总控。它们首先连接到<strong>公网路由器</strong>，然后通过<strong>公网交换机</strong>到达总控节点。</li>
<li><strong>总控节点</strong>被部署在一个公网可访问的网络内，允许来自互联网的访问。</li>
<li><strong>数据中心网络</strong>内包括引擎集群（管理面、调度集群、工作集群），它们通过<strong>数据中心路由器</strong>和<strong>数据中心交换机</strong>连接。</li>
<li><strong>管理面集群</strong>中的节点通过Keepalived实现高可用性，使用虚拟IP（VIP）为入口点。</li>
<li>VIP用于路由请求到<strong>调度集群</strong>，然后调度集群将任务分配给<strong>工作集群</strong>进行处理。</li>
</ul>
<h2 id="改造后物理架构"><a href="#改造后物理架构" class="headerlink" title="改造后物理架构"></a>改造后物理架构</h2><p><img src="http://119.91.145.27:12799/api/public/dl/p8KdAUHH/sr_mmrefactor_before.png" alt="通信链路改造前静态拓扑"></p>
<p><img src="http://119.91.145.27:12799/api/public/dl/p8KdAUHH/sr_mmrefactor_after_network.png" alt="通信链路改造后静态拓扑"></p>
<p><img src="http://119.91.145.27:12799/api/public/dl/p8KdAUHH/sr_mmrefactor_sem1.png" alt="a"></p>
<p><img src="http://119.91.145.27:12799/api/public/dl/p8KdAUHH/sr_mmrefactor_ses.png" alt="sr_mmrefactor_ses"></p>
<p><img src="http://119.91.145.27:12799/api/public/dl/p8KdAUHH/sr_mmrefactor_sew.png" alt="通信链路改造-工作节点故障转移"></p>
<h2 id="问题场景"><a href="#问题场景" class="headerlink" title="问题场景"></a>问题场景</h2><h3 id="云服务场景"><a href="#云服务场景" class="headerlink" title="云服务场景"></a>云服务场景</h3><p>公有云服务中一般 VIP 需要单独开，给服务部署带来更多要求。</p>
<h3 id="灾难恢复"><a href="#灾难恢复" class="headerlink" title="灾难恢复"></a>灾难恢复</h3><p>Keepalived主要设计用于单个数据中心或地理位置相近的网络中的高可用性。网络波动大、延时波动大的情况下，Keepalived 会出现频繁切主现象。</p>
<h3 id="监控日志管理"><a href="#监控日志管理" class="headerlink" title="监控日志管理"></a>监控日志管理</h3><p>虽然Keepalived提供基本的日志记录功能，但在复杂系统中，集成更先进的监控和日志分析通常是必需的，团队中没有修改 Keepalived 代码能力。</p>
<h3 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h3><p>Vrrp 协议本身是未加密的通信，并且可能在用户网络中与已有的组播冲突 （224.0.0.18）</p>
<h3 id="功能限制"><a href="#功能限制" class="headerlink" title="功能限制"></a>功能限制</h3><p>Keepalived 是做服务器层面高可用，不可能在此基础上做应用高可用。</p>
<h3 id="复杂"><a href="#复杂" class="headerlink" title="复杂"></a>复杂</h3><p>对于一些简单的高可用性需求，Keepalived的功能和配置可能显得过于复杂，特别是在没有负载均衡需求时。 </p>
<h3 id="技术栈不匹配"><a href="#技术栈不匹配" class="headerlink" title="技术栈不匹配"></a>技术栈不匹配</h3><p>Keepalived 使用 ANSI C 编写，引擎管理面使用 Golang，技术栈上不匹配，后期不能维护</p>
<h3 id="Web界面适配困难"><a href="#Web界面适配困难" class="headerlink" title="Web界面适配困难"></a>Web界面适配困难</h3><p>只提供文本文件进行配置。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://keepalived-doc.readthedocs.io/zh-cn/latest/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1.html">https://keepalived-doc.readthedocs.io/zh-cn/latest/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1.html</a></li>
</ul>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 Xiaoy
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;xiaoy
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
