
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>flutter技巧.md | Xiaoy</title>
    <meta name="author" content="xiaoy" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>XIAOY</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;XIAOY</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>flutter技巧.md</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/2/18
        </span>
        
        <span class="category">
            <a href="/categories/domain/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                domain
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/dart/" style="color: #ff7d73">
                    dart
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/flutter/" style="color: #03a9f4">
                    flutter
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h2 id="组件封装"><a href="#组件封装" class="headerlink" title="组件封装"></a>组件封装</h2><h3 id="封装-flutter-组件"><a href="#封装-flutter-组件" class="headerlink" title="封装 flutter 组件"></a>封装 flutter 组件</h3><h2 id="当出现两个-变量-同时决定页面展示时，使用同一个函数封装"><a href="#当出现两个-变量-同时决定页面展示时，使用同一个函数封装" class="headerlink" title="当出现两个 变量 同时决定页面展示时，使用同一个函数封装"></a>当出现两个 变量 同时决定页面展示时，使用同一个函数封装</h2><pre><code class="dart">var taskLs = [fakeTask, fakeSonTask, fakeSonSonTask, fakeSonTask2, fakeTask2];
TaskManifest? selectedManifest;

class TaskManager with ChangeNotifier &#123;
  List&lt;Task&gt; getTaskLs() &#123;
    return taskLs;
  &#125;

  bool createTaskOrUpdateManifest(&#123;Task? task, TaskManifest? manifest&#125;) &#123;
    if (manifest != null) &#123;
      selectedManifest = manifest;
      notifyListeners();
    &#125; else if (task != null) &#123;
      taskLs.add(task);
      notifyListeners();
    &#125; else &#123;
      print(&quot;unknown&quot;);
      return false;
    &#125;
    return true;
  &#125;

  List&lt;Task&gt; getRootTaskLs() &#123;
    print(&quot;---: $selectedManifest $&#123;selectedManifest?.name&#125;&quot;);
    var ls = &lt;Task&gt;[];

    for (final task in getTaskLs()) &#123;
      if (task.manifestId == selectedManifest?.id) &#123;
        if (task.isRoot == true) &#123;
          ls.add(task);
        &#125;
      &#125;
    &#125;
    getTaskLs().forEach((element) &#123;
      print(&quot;el: $element&quot;);&#125;
    );
    return ls;
  &#125;
&#125;
</code></pre>
<h2 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h2><h3 id="cast"><a href="#cast" class="headerlink" title="cast"></a>cast</h3><p>在Dart中，<code>cast</code>函数是一个非常有用的工具，它允许你将一个集合的元素类型转换为另一个类型。这在处理<code>dynamic</code>类型或不同类型之间的转换时尤其有用，但需要谨慎使用以避免运行时错误。下面是使用<code>cast</code>函数的一些最佳实践：</p>
<h4 id="1-明确知道元素类型时使用"><a href="#1-明确知道元素类型时使用" class="headerlink" title="1. 明确知道元素类型时使用"></a>1. 明确知道元素类型时使用</h4><p>只有当你确定集合中的所有元素都可以安全地被转换为目标类型时，才使用<code>cast</code>。这通常适用于你从动态类型（如从数据库、外部数据源或第三方库中获取的数据）转换到具体类型时。</p>
<h4 id="2-避免不必要的类型转换"><a href="#2-避免不必要的类型转换" class="headerlink" title="2. 避免不必要的类型转换"></a>2. 避免不必要的类型转换</h4><p>如果你能通过设计来确保数据的类型安全，那么尽量避免使用<code>cast</code>。比如，使用泛型集合来存储和传递具体类型的数据，这样可以让Dart的静态类型检查帮助你捕获类型错误。</p>
<h4 id="3-处理cast可能失败的情况"><a href="#3-处理cast可能失败的情况" class="headerlink" title="3. 处理cast可能失败的情况"></a>3. 处理<code>cast</code>可能失败的情况</h4><p>使用<code>cast</code>时，如果集合中有任何元素不能被转换为目标类型，都会抛出运行时异常。因此，使用<code>cast</code>时应该尽量确保转换的安全性，或者使用try-catch结构来处理可能的异常。</p>
<h4 id="4-优先使用类型安全的替代方案"><a href="#4-优先使用类型安全的替代方案" class="headerlink" title="4. 优先使用类型安全的替代方案"></a>4. 优先使用类型安全的替代方案</h4><p>在某些情况下，你可以通过映射（<code>.map()</code>）集合并手动转换每个元素来避免使用<code>cast</code>。这样做的好处是可以在转换每个元素时提供一个回退方案，比如：</p>
<pre><code class="dart">var list = &lt;dynamic&gt;[1, 2, 3];
var intList = list.map((e) =&gt; e as int).toList();
</code></pre>
<p>这种方法比<code>cast</code>更加类型安全，因为你可以控制转换的过程，并且在转换失败时捕获异常。</p>
<h4 id="5-谨慎使用cast改变集合的可变性"><a href="#5-谨慎使用cast改变集合的可变性" class="headerlink" title="5. 谨慎使用cast改变集合的可变性"></a>5. 谨慎使用<code>cast</code>改变集合的可变性</h4><p>当你对集合使用<code>cast</code>时，返回的是原始集合的一个视图，这意味着原始集合和转换后的集合在底层是相同的数据。对任一集合的修改都会影响另一个，但如果集合的类型不兼容，这种修改可能会引起问题。</p>
<h4 id="6-在混合类型数据流中使用"><a href="#6-在混合类型数据流中使用" class="headerlink" title="6. 在混合类型数据流中使用"></a>6. 在混合类型数据流中使用</h4><p>在处理混合类型的数据流时（比如一个列表包含了不同类型的对象），<code>cast</code>可以用来过滤出特定类型的对象集合，以便进行进一步处理。</p>
<pre><code>  List&lt;Task&gt; getTaskLs() &#123;
    // 直接返回Hive box中所有的Task对象
    if (taskBox != null) &#123;
      return taskBox!.values.cast&lt;Task&gt;().toList();
    &#125; else &#123;
      return [];
    &#125;
  &#125;
</code></pre>
<h2 id="as-类型转换"><a href="#as-类型转换" class="headerlink" title="as 类型转换"></a>as 类型转换</h2><p>在Dart语言中，<code>as</code>关键字用于类型转换，将一个对象显式地转换为另一个类型。尽管这是一个强大的功能，但如果不当使用，可能会导致运行时错误。以下是使用<code>as</code>进行类型转换的一些最佳实践：</p>
<h3 id="1-当你确定转换是安全的时使用"><a href="#1-当你确定转换是安全的时使用" class="headerlink" title="1. 当你确定转换是安全的时使用"></a>1. 当你确定转换是安全的时使用</h3><p>只在你确信对象可以被安全地转换为目标类型时使用<code>as</code>。这通常是在你通过某些方式（例如通过类型检查）已经验证了对象的类型后。</p>
<pre><code class="dart">if (object is TargetType) &#123;
  final targetTypeObject = object as TargetType;
&#125;
</code></pre>
<h3 id="2-优先使用类型测试运算符is"><a href="#2-优先使用类型测试运算符is" class="headerlink" title="2. 优先使用类型测试运算符is"></a>2. 优先使用类型测试运算符<code>is</code></h3><p>在尝试将一个对象转换为特定类型之前，先使用<code>is</code>运算符检查对象是否为目标类型。这可以避免在转换失败时抛出异常。</p>
<pre><code class="dart">if (object is TargetType) &#123;
  // 安全地使用object作为TargetType
&#125;
</code></pre>
<h3 id="3-避免不必要的as使用"><a href="#3-避免不必要的as使用" class="headerlink" title="3. 避免不必要的as使用"></a>3. 避免不必要的<code>as</code>使用</h3><p>如果Dart的类型推断能够正确识别对象的类型，就没有必要使用<code>as</code>进行显式转换。过度使用<code>as</code>可能会降低代码的可读性和维护性。</p>
<h3 id="4-在处理泛型时谨慎使用"><a href="#4-在处理泛型时谨慎使用" class="headerlink" title="4. 在处理泛型时谨慎使用"></a>4. 在处理泛型时谨慎使用</h3><p>当你与泛型类型打交道时，特别是当类型参数在运行时可能变化时，使用<code>as</code>进行类型转换需要格外小心。在这种情况下，确保转换是安全的，或者考虑使用更安全的替代方案。</p>
<h3 id="5-处理as转换可能失败的情况"><a href="#5-处理as转换可能失败的情况" class="headerlink" title="5. 处理as转换可能失败的情况"></a>5. 处理<code>as</code>转换可能失败的情况</h3><p>尽管通过<code>is</code>检查类型可以避免大多数问题，但在某些情况下，转换可能仍然失败。使用<code>as</code>时，考虑包含异常处理逻辑，特别是当处理外部数据或在你对数据源不完全确定时。</p>
<pre><code class="dart">try &#123;
  final targetTypeObject = object as TargetType;
&#125; catch (e) &#123;
  // 处理转换失败的情况
&#125;
</code></pre>
<h3 id="6-使用类型安全的集合操作"><a href="#6-使用类型安全的集合操作" class="headerlink" title="6. 使用类型安全的集合操作"></a>6. 使用类型安全的集合操作</h3><p>当从集合中获取元素时，如果你确信集合中的所有元素都属于一个特定类型，使用<code>as</code>进行转换可以使代码更简洁。但是，仍然推荐使用<code>is</code>进行检查，或者使用泛型来保证类型安全。</p>
<h3 id="7-避免将as用作隐藏逻辑错误的手段"><a href="#7-避免将as用作隐藏逻辑错误的手段" class="headerlink" title="7. 避免将as用作隐藏逻辑错误的手段"></a>7. 避免将<code>as</code>用作隐藏逻辑错误的手段</h3><p>错误地使用<code>as</code>可能会隐藏潜在的逻辑错误，导致难以调试的运行时异常。在使用<code>as</code>之前，仔细考虑是否有其他方式（如改进程序逻辑或使用更合适的类型）来解决问题。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p><code>as</code>关键字是Dart中强大的类型转换工具，但应谨慎使用。始终确保转换的安全性，优先使用类型检查运算符<code>is</code>，并在适当的地方处理可能的异常，以编写更安全、更健壯的Dart代码。</p>
<h2 id="TaskContainerState-状态延迟刷新问题"><a href="#TaskContainerState-状态延迟刷新问题" class="headerlink" title="_TaskContainerState 状态延迟刷新问题"></a>_TaskContainerState 状态延迟刷新问题</h2><h3 id="背景描述"><a href="#背景描述" class="headerlink" title="背景描述"></a>背景描述</h3><p><code>TaskContainer</code> 组件下的  <code>_TaskContainerState build</code> 定义为</p>
<pre><code class="dart">Widget build(BuildContext context) &#123;
    // 初始状态 只有一个 SingleTaskP
    // 展开状态 有多个 SingleTaskP
    List&lt;Widget&gt; loadSonTaskContainerLs(Set set) &#123;
        if (_isFolded || !_haveSon) &#123;
            return [const SizedBox()];
        &#125; else &#123;
            // 获取所有下一层级的 task
            List&lt;TaskContainer&gt; ls = &lt;TaskContainer&gt;[];
            for (final id in set) &#123;
                ls.add(TaskContainer(indentTime: increaseIndentTime(widget.indentTime), task: taskDBRead.getTaskById(id)));
            &#125;
            return ls;
        &#125;
    &#125;

    return Consumer&lt;TaskUpdateModel&gt;(
        builder: (context, taskUpdateModel, child) &#123;
            final set = taskUpdateModel.getSonTaskIdLsFromParentId(widget.task!.id);

            _haveSon = set.isEmpty ? false : true;
            print(&quot;set: $&#123;set.length&#125; , haveson: $_haveSon, isFold: $_isFolded&quot;);
            //print(&quot;foldIconButton : $foldIconButton&quot;);
            return Row(
                crossAxisAlignment: CrossAxisAlignment.start, // 确保Row的子项从顶部开始对齐
                children: [
                    Container(
                        width: 48, // 或其他适当的值，确保足够容纳IconButton
                        child: _haveSon ? Container(
                            margin: const EdgeInsets.all(12),
                            child: IconButton(   // 这里之前写在 return 之前
                                onPressed: () &#123;
                                    setState(() &#123;
                                        _isFolded = !_isFolded;
                                    &#125;);
                                &#125;,
                                icon: Icon(
                                    _isFolded
                                    ? Icons.arrow_drop_down_rounded
                                    : Icons.arrow_right_rounded,
                                    size: 24,
                                ),
                            ))
                        : Container(),
                    ),
                    Expanded( // 使用Expanded来填充剩余空间
                        child: Column(
                            children: [
                                SingleTaskP(widget.indentTime, widget.task),
                                if (!_isFolded &amp;&amp; _haveSon) ...loadSonTaskContainerLs(set),
                            ],
                        ),
                    ),
                ],
            );
        &#125;
    );
&#125;
</code></pre>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 Xiaoy
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;xiaoy
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
