
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Linux应用rootless化整理.md | Xiaoy</title>
    <meta name="author" content="xiaoy" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>XIAOY</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;XIAOY</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>Linux应用rootless化整理.md</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/2/27
        </span>
        
        <span class="category">
            <a href="/categories/domain/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                domain
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/linux/" style="color: #03a9f4">
                    linux
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>以一个应用为例，描述为一个应用不使用 root 用户在 <code>运行</code> 的生命周期需要进行的操作。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><code>Unix and Linux System Administration Handbook (Evi Nemeth, Garth Snyder, Trent R. Hein etc.) (Z-Library)</code></p>
<h2 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h2><h3 id="当软件系统允许使用sudo组用户运行时"><a href="#当软件系统允许使用sudo组用户运行时" class="headerlink" title="当软件系统允许使用sudo组用户运行时"></a>当软件系统允许使用<code>sudo</code>组用户运行时</h3><ul>
<li><strong>提权能力</strong>：确实，如果软件系统允许使用属于<code>sudo</code>组的用户运行，那么这些用户可以通过<code>sudo</code>命令暂时获得<code>root</code>用户的权限。这意味着他们可以执行通常需要<code>root</code>权限的操作，例如访问受保护的文件、修改系统设置、安装或卸载软件包等。</li>
<li><strong>安全和控制</strong>：虽然这种方法提供了很大的灵活性和方便性，但也带来了潜在的安全风险。因为<code>sudo</code>允许用户执行任何命令，所以必须谨慎配置<code>/etc/sudoers</code>文件，以限制用户可以执行的命令范围，遵循最小权限原则。</li>
</ul>
<h3 id="当软件系统不允许使用sudo组用户运行时"><a href="#当软件系统不允许使用sudo组用户运行时" class="headerlink" title="当软件系统不允许使用sudo组用户运行时"></a>当软件系统不允许使用<code>sudo</code>组用户运行时</h3><ul>
<li><strong>权限规划</strong>：在这种情况下，确实需要事先规划和整理软件系统运行所需的所有权限。这包括文件访问权限、网络端口使用权限、特定系统资源的访问等。</li>
<li><strong>安装时授权</strong>：在软件安装过程中，必须确保所有必要的资源和组件都被正确地授予给将要运行软件的用户账户。这可能包括设置文件和目录的所有权和权限、调整系统配置以允许非<code>root</code>用户访问特定的端口或服务等。</li>
<li><strong>无提权手段</strong>：使用非<code>sudo</code>组用户运行的应用确实没有再次提权的手段。这就要求软件的安装、配置和运行必须在不需要进一步提权的情况下进行。这种方法有助于提高系统的安全性，因为它限制了软件在系统上可能造成的影响范围。</li>
</ul>
<p><strong>创建系统用户需用更高权限</strong></p>
<pre><code class="bash"># 以创建用户 sysuser 为例，创建 sudo 组用户
sudo useradd -m sysuser 
sudo passwd sysuser  # 这里要输入密码
sudo usermod -aG sudo sysuser
</code></pre>
<pre><code class="bash"># 以创建用户 sysuser 为例，创建非 sudo 组用户
sudo useradd -m sysuser 
sudo passwd sysuser  # 这里要输入密码
</code></pre>
<h2 id="应用的文件访问"><a href="#应用的文件访问" class="headerlink" title="应用的文件访问"></a>应用的文件访问</h2><p>从文件归属和访问需求角度进行分类</p>
<h3 id="1-应用程序文件"><a href="#1-应用程序文件" class="headerlink" title="1. 应用程序文件"></a>1. 应用程序文件</h3><ul>
<li><strong>定义</strong>：这些是应用程序的核心文件，包括可执行文件、库文件等。</li>
<li><strong>归属</strong>：通常归属于 root 或特定的应用用户。</li>
<li><strong>访问需求</strong>：这些文件需要执行权限，但通常不需要写权限，以确保应用的完整性和安全性。</li>
</ul>
<h3 id="2-配置文件"><a href="#2-配置文件" class="headerlink" title="2. 配置文件"></a>2. 配置文件</h3><ul>
<li><strong>定义</strong>：包含应用程序运行所需的配置信息的文件。</li>
<li><strong>归属</strong>：可能归属于 root、特定的应用用户或配置管理组。</li>
<li><strong>访问需求</strong>：在应用启动或配置更改时需要读取权限，少数情况下（如通过应用内部功能更新配置）可能需要写权限。</li>
</ul>
<h3 id="3-日志文件"><a href="#3-日志文件" class="headerlink" title="3. 日志文件"></a>3. 日志文件</h3><ul>
<li><strong>定义</strong>：应用程序运行时产生的日志信息存储文件。</li>
<li><strong>归属</strong>：通常归属于运行应用程序的用户或特定日志用户组。</li>
<li><strong>访问需求</strong>：需要写权限以记录运行时信息；对于日志审计和故障排查，需要读权限。</li>
</ul>
<h3 id="4-数据文件"><a href="#4-数据文件" class="headerlink" title="4. 数据文件"></a>4. 数据文件</h3><ul>
<li><strong>定义</strong>：应用程序用于存储数据的文件，如数据库文件、用户上传的文件等。</li>
<li><strong>归属</strong>：归属于特定的数据管理用户或组或应用程序用户。</li>
<li><strong>访问需求</strong>：根据应用功能，可能需要读、写、创建和删除权限。</li>
</ul>
<h3 id="5-临时文件"><a href="#5-临时文件" class="headerlink" title="5. 临时文件"></a>5. 临时文件</h3><ul>
<li><strong>定义</strong>：应用程序运行时临时创建的文件，用于处理数据、缓存等。</li>
<li><strong>归属</strong>：归属于运行应用程序的用户。</li>
<li><strong>访问需求</strong>：通常需要读写权限，运行完毕后可能需要删除权限。</li>
</ul>
<h3 id="6-外部设备和资源文件"><a href="#6-外部设备和资源文件" class="headerlink" title="6. 外部设备和资源文件"></a><del>6. 外部设备和资源文件</del></h3><ul>
<li><del><strong>定义</strong>：应用程序可能需要访问的外部设备（如USB设备）或网络资源（如通过网络共享访问的文件）。</del></li>
<li><del><strong>归属</strong>：这些文件的归属和权限由外部系统或网络协议定义。</del></li>
<li><del><strong>访问需求</strong>：根据外部资源的性质，可能需要特定的读写权限。</del></li>
</ul>
<h2 id="应用的网络管理"><a href="#应用的网络管理" class="headerlink" title="应用的网络管理"></a>应用的网络管理</h2><h2 id="应用的虚拟化权限管理"><a href="#应用的虚拟化权限管理" class="headerlink" title="应用的虚拟化权限管理"></a>应用的虚拟化权限管理</h2><h3 id="docker-相关"><a href="#docker-相关" class="headerlink" title="docker 相关"></a>docker 相关</h3><p><code>Unix and Linux System Administration Handbook</code> <code>Chapter 25 Containers</code>  Container in practice  中有一个例子讲述关于 docker 权限过高导致的风险以及如何管理有 docker 的 Linux 系统的权限分配方案</p>
<h2 id="未整理的提权操作"><a href="#未整理的提权操作" class="headerlink" title="未整理的提权操作"></a>未整理的提权操作</h2><ol>
<li><strong>安装或卸载软件包</strong>：在系统级别安装或卸载软件，特别是使用包管理器（如APT、YUM或Pacman）时。</li>
<li><strong>修改系统文件</strong>：编辑位于<code>/etc</code>、<code>/var</code>等目录下的配置文件。这些文件通常控制系统的启动、网络配置、安全策略等。</li>
<li><strong>管理用户和用户组</strong>：创建、修改或删除用户账户和用户组，以及修改用户权限。</li>
<li><strong>更改文件所有权</strong>：使用<code>chown</code>命令更改文件或目录的所有者，特别是当这些文件属于其他用户或系统用户时。</li>
<li><strong>配置网络设置</strong>：更改IP地址、路由表、防火墙规则等网络配置。</li>
<li><strong>管理系统服务</strong>：启动、停止、重启系统服务或守护进程，如Web服务器、数据库服务等。</li>
<li><strong>监听低编号端口</strong>：通常，只有<code>root</code>用户才能监听1024以下的端口，这些端口被认为是“特权”端口。</li>
<li><strong>分配受保护的硬件资源</strong>：例如，配置新的硬盘、分区和文件系统，或者直接访问某些硬件设备。</li>
<li><strong>设置系统时间和日期</strong>：更改系统的当前时间和日期，包括与网络时间协议（NTP）服务器的同步。</li>
<li><strong>访问日志文件</strong>：查看位于<code>/var/log</code>目录下的系统日志文件，这些文件通常包含重要的系统运行和安全信息。</li>
<li><strong>修改内核参数</strong>：使用<code>sysctl</code>或直接编辑<code>/proc/sys/</code>目录下的文件来调整内核运行时参数。</li>
<li><strong>配置定时任务</strong>：为系统级别的定时任务配置<code>cron</code>作业，需要编辑<code>/etc/crontab</code>文件或在<code>/etc/cron.*</code>目录下添加脚本。</li>
<li><strong>管理持久性存储设备</strong>：格式化和分区硬盘，管理逻辑卷（使用LVM），或者修改文件系统（如使用<code>fsck</code>命令检查和修复文件系统）。</li>
<li><strong>控制防火墙和安全设置</strong>：配置<code>iptables</code>或<code>firewalld</code>规则，管理SELinux或AppArmor安全策略。</li>
<li><strong>访问受限日志和数据文件</strong>：某些日志文件和数据文件因包含敏感信息而受到保护，只有<code>root</code>用户才能访问。</li>
<li><strong>管理虚拟化资源</strong>：创建和管理虚拟机或容器（如使用KVM、Docker等），通常需要更高权限来访问和分配硬件资源。</li>
<li><strong>备份和恢复操作</strong>：对系统文件进行备份和恢复时，尤其是使用工具直接访问原始设备或进行大范围文件系统操作。</li>
<li><strong>修改引导加载器配置</strong>：配置GRUB或其他引导加载器的设置，如更改启动参数或管理多重启动设置。</li>
<li><strong>加载或卸载内核模块</strong>：使用<code>modprobe</code>、<code>insmod</code>或<code>rmmod</code>命令加载或卸载内核模块。</li>
<li><strong>直接访问设备文件</strong>：通过<code>/dev</code>目录下的设备文件直接与硬件通信，比如进行磁盘I&#x2F;O操作或配置特定的硬件设备。</li>
</ol>
<p>网络相关</p>
<ol>
<li><strong>修改网络接口配置</strong>：配置或更改网络接口的IP地址、子网掩码、网关等参数，通常通过<code>ifconfig</code>（已经较少使用）或<code>ip</code>命令进行。</li>
<li><strong>配置路由表</strong>：添加或删除路由规则，管理系统的路由表，这对于定制网络流量的路径非常重要，可以使用<code>route</code>或<code>ip route</code>命令。</li>
<li><strong>配置和管理防火墙</strong>：设置或更改<code>iptables</code>、<code>nftables</code>或<code>firewalld</code>等防火墙工具的规则，以控制进出网络流量的允许或禁止。</li>
<li><strong>启动网络服务</strong>：在低于1024的端口启动网络服务，这些端口被认为是特权端口，很多基础网络服务（如HTTP、HTTPS、SSH）默认运行在这些端口上。</li>
<li><strong>配置端口转发和NAT（网络地址转换）</strong>：通过<code>iptables</code>或其他网络工具配置端口转发和NAT规则，这对于网络地址和端口的映射非常重要，特别是在多个网络之间进行通信时。</li>
<li><strong>监控和捕获网络流量</strong>：使用<code>tcpdump</code>、<code>wireshark</code>（在非图形界面环境中使用<code>tshark</code>）等工具监控和捕获网络接口上的流量，通常需要更高权限来访问网络接口。</li>
<li><strong>修改系统的网络设置</strong>：比如通过<code>sysctl</code>命令调整TCP&#x2F;IP栈的行为，例如改变IP转发、TCP窗口缩放等参数。</li>
<li><strong>管理VPN和其他隧道接口</strong>：设置和配置VPN连接或其他类型的网络隧道，如IPsec、OpenVPN或WireGuard等，这些操作需要访问网络配置和安全密钥。</li>
<li><strong>绑定到特权端口</strong>：除了启动网络服务外，直接绑定到1024以下的特权端口进行监听也需要更高的权限。</li>
<li><strong>配置动态主机配置协议（DHCP）</strong>：设置和管理DHCP服务器或客户端，为网络设备动态分配IP地址。</li>
</ol>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>在如今虚拟化如此普及的今天，要么，应用都在容器中被隔离，要么，大厂商的软件都是独占机器的，机器和软件都是一家的，是否真的有收紧权限的必要性，是不是从找到漏洞的角度去做到安全更 “合理”。</p>
<h3 id="解答"><a href="#解答" class="headerlink" title="解答"></a>解答</h3><h3 id="最小权限原则"><a href="#最小权限原则" class="headerlink" title="最小权限原则"></a>最小权限原则</h3><ul>
<li><strong>安全最佳实践</strong>：即使在高度隔离的环境中，应用最小权限原则（Least Privilege Principle）仍然是安全最佳实践的核心。这个原则要求只授予完成特定任务所必需的最少权限，从而限制安全漏洞被利用的潜在影响。</li>
</ul>
<h3 id="容器与虚拟化环境的漏洞"><a href="#容器与虚拟化环境的漏洞" class="headerlink" title="容器与虚拟化环境的漏洞"></a>容器与虚拟化环境的漏洞</h3><ul>
<li><strong>隔离并非万无一失</strong>：虽然容器和虚拟机提供了隔离环境，但它们自身也可能包含漏洞，这些漏洞可能被利用来逃逸隔离或提升权限。例如，历史上曾经发现过多个容器逃逸漏洞。</li>
</ul>
<h3 id="内部威胁与配置错误"><a href="#内部威胁与配置错误" class="headerlink" title="内部威胁与配置错误"></a>内部威胁与配置错误</h3><ul>
<li><strong>内部威胁</strong>：过宽的权限设置不仅增加了外部攻击者的攻击面，也增加了内部威胁的风险。一个内部人员或恶意软件可能利用不必要的高权限来进行数据泄露、破坏或其他恶意行为。</li>
<li><strong>配置错误</strong>：权限设置过宽还可能导致配置错误，从而无意中暴露敏感数据或系统功能。随着环境变得更加复杂，这种风险也相应增加。</li>
</ul>
<h3 id="法规和合规性要求"><a href="#法规和合规性要求" class="headerlink" title="法规和合规性要求"></a>法规和合规性要求</h3><ul>
<li><strong>合规性要求</strong>：许多行业和国际标准（如GDPR、HIPAA、PCI DSS）对数据保护和访问控制有严格要求。实施严格的权限控制是满足这些要求的关键组成部分。</li>
</ul>
<h3 id="安全与漏洞发现的平衡"><a href="#安全与漏洞发现的平衡" class="headerlink" title="安全与漏洞发现的平衡"></a>安全与漏洞发现的平衡</h3><ul>
<li><strong>漏洞发现重要，但不是唯一解决方案</strong>：虽然发现并修补安全漏洞是提高软件安全性的重要手段，但仅依赖于漏洞发现并不足以全面保障安全。权限管理是构建深度防御策略（Defense in Depth）的一个重要方面，能够在漏洞被发现并利用之前提供额外的保护层。</li>
</ul>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 Xiaoy
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;xiaoy
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
