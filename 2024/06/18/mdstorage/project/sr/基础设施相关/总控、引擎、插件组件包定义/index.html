
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>总控、引擎、插件组件包定义.md | Xiaoy</title>
    <meta name="author" content="xiaoy" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>XIAOY</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;XIAOY</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>总控、引擎、插件组件包定义.md</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/6/18
        </span>
        
        
    </div>
    
    <div class="content" v-pre>
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>总控、引擎、插件包定义，构建、导入等关键流程实现方案，和接口设计</p>
<h2 id="组件包定义"><a href="#组件包定义" class="headerlink" title="组件包定义"></a>组件包定义</h2><p>总控、引擎、插件、Agent 等为大组件，它们的发布时按照下面协议约定构建出的文件称为组件包，导入到总控平台后，会在平台中生成对应可用组件，提供用户使用相应功能。结合平台自身环境，在导入后有不同的用户交互，如流量引擎组件包新导入总控平台时，平台会出现流量引擎安装交互接口，当之前已有可用的流量引擎组件时，平台则会出现流量引擎升级交互接口。</p>
<h3 id="组件包结构"><a href="#组件包结构" class="headerlink" title="组件包结构"></a>组件包结构</h3><ul>
<li><p><strong>基本信息：</strong></p>
<p>  name：组件包的名称，使用产品定义的组件英文简称。<br>  version：组件包的当前版本。<br>  description：组件包的简要描述。<br>  type：组件包的类型，包括sc（总控组件）、engine（引擎组件）、plugin（插件组件）、agent（代理组件）。</p>
</li>
<li><p><strong>依赖信息：</strong></p>
<p>  dependencies：组件包所依赖的其他组件包列表，包括依赖项的名称、版本范围、类型、兼容版本、不兼容版本和描述。</p>
</li>
<li><p><strong>完整性校验：</strong></p>
<p>  checksum：包含整个压缩包的校验和信息，用于校验包的完整性。</p>
</li>
<li><p><strong>版本更新日志：</strong></p>
<p>  changelog：此版本更新内容。</p>
</li>
<li><p><strong>运行相关内容：</strong></p>
</li>
</ul>
<h3 id="组件包生命周期"><a href="#组件包生命周期" class="headerlink" title="组件包生命周期"></a>组件包生命周期</h3><h4 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h4><p>构建顺序：</p>
<ul>
<li>运行相关内容</li>
<li>基本信息、依赖管理、完整性校验</li>
</ul>
<h4 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h4><p>导入时会将组件包元信息录入到平台数据库中，以作安装、升级管理界面查看使用，在平台中生成用户可交互的组件</p>
<p>组件用户操作接口</p>
<ul>
<li>安装、升级、回退（插件有）、回滚、取消安装、卸载、强制卸载、备份（引擎有）、备份恢复（引擎有）</li>
</ul>
<h3 id="组件包内容"><a href="#组件包内容" class="headerlink" title="组件包内容"></a>组件包内容</h3><h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><p>组件包文件格式为 ${组件名}_v${version}.${os_name}-${arch}.tar.gz  SC_v1.5.6.linux-x86_64.tar.gz<br>使用 tar -zxvf 解压后为以下目录接口</p>
<pre><code class="Bash">SC_v1.5.15.linux-x86_64/
│ ├── nsq
│ │ ├── bin
│ │ ├── hack
│ │ └── systemd
│ ├── redis
│ │ ├── bin
│ │ ├── etc
│ │ └── hack
│ ├── sc
│ │ ├── bin
│ │ ├── certificate
│ │ ├── config
│ │ ├── data
│ │ ├── depends
│ │ ├── dist
│ │ ├── doc
│ │ ├── hack
│ │ ├── log
│ │ ├── systemd
│ │ └── template
│ ├── sc-core
│ │ ├── bin
│ │ ├── config
│ │ └── hack
│ ├── script
│ │ ├── check.sh
│ │ ├── config
│ │ ├── install.sh
│ │ ├── os_info.env
│ │ ├── uninstall.sh
│ │ └── update_ui.sh
│ └── template
│     ├── install.sh
│     ├── leakScan
│     ├── README.md
│     ├── sensitive
│     ├── sqlInject
│     ├── uninstall.sh
│     ├── upgrade.sh
│     ├── waf
│     └── wpd
├── meta.json
├── install.sh
├── uninstall.sh


</code></pre>
<h4 id="生命周期管理信息"><a href="#生命周期管理信息" class="headerlink" title="生命周期管理信息"></a>生命周期管理信息</h4><h4 id="发布信息"><a href="#发布信息" class="headerlink" title="发布信息"></a>发布信息</h4><h5 id="版本更新日志-changelog"><a href="#版本更新日志-changelog" class="headerlink" title="版本更新日志 changelog"></a>版本更新日志 changelog</h5><p><strong>格式</strong></p>
<pre><code class="Text">## [1.2.0] - 2024-06-18
### Added
- 新特性 A
- 新特性 B

### Fixed
- Bug X
- Bug Y

### Improved
- 操作体验优化 Z
</code></pre>
<p>生命周期说明： 发布时由产品发布此文件，导入时解析此文件，并存入到数据库，安装包、升级包清理时，文件随包一起清理。有必要时，清理无用包信息，可以删除此信息</p>
<h5 id="依赖信息-checksum-meta-json"><a href="#依赖信息-checksum-meta-json" class="headerlink" title="依赖信息 checksum  meta.json"></a>依赖信息 checksum  meta.json</h5><p>需要最后填充此信息，因为里面包含 checksum 信息，用于包完整性校验</p>
<ul>
<li><strong>sc示例</strong></li>
</ul>
<pre><code class="json">&#123;
  &quot;name&quot;: &quot;SC&quot;,
  // 产品定义的组件英文简称 https://doc.weixin.qq.com/sheet/e3_AIgA6waJABcW3JvHCTFSyGeeGr7PY?scode=ABwA9Qd2ABEu5XCNS9Ab8AhQbAADQ&amp;tab=BB08J2
  &quot;version&quot;: &quot;1.7.0&quot;,
  // 发布版本号
  &quot;description&quot;: &quot;总控组件包&quot;,
  &quot;type&quot;: &quot;sc&quot;,
  // sc engine plugin agent
  &quot;checksum&quot;: &#123;
    &quot;v1&quot;: &quot;1234567890abcdef1234567890abcdef&quot;
  &#125;,
  &quot;dependencies&quot;: [
    // 依赖管理
    &#123;
      &quot;name&quot;: &quot;SE&quot;,
      &quot;type&quot;: &quot;engine&quot;,
      &quot;compatible_versions&quot;: [&quot;&gt;=2.1.0&quot;, &quot;&lt;3.0.0&quot;],
      &quot;incompatible_versions&quot;: [
        &quot;2.1.2&quot;
      ],
      &quot;description&quot;: &quot;引擎组件包&quot;
    &#125;
  ],
  &quot;proto_version&quot;: 1,   // 协议版本
  &quot;changelog&quot;: &quot;This is the changelog content. \n- Added new features \n- Fixed bugs \n- Improved performance&quot;,
  &quot;component&quot;: [&quot;sc&quot;, &quot;sc-core&quot;, &quot;installer&quot;],       // 这里就是组件目录名，组件名要和组件目录名一致，也就是在 able.json 中 name 要对上
&#125;


</code></pre>
<ul>
<li><strong>引擎示例</strong></li>
</ul>
<pre><code class="json">&#123;
  &quot;name&quot;: &quot;SE&quot;,    // 产品定义的组件英文简称
  &quot;version&quot;: &quot;2.1.1&quot;,    // 发布版本号
  &quot;description&quot;: &quot;引擎组件包&quot;,
  &quot;type&quot;: &quot;engine&quot;,     // sc engine plugin agent
  &quot;checksum&quot;: &#123;
    &quot;v1&quot;: &quot;1234567890abcdef1234567890abcdef&quot;,   
  &#125;,
  &quot;comp&quot;: &#123;&#125;,       // 小组件和目录
  &quot;dependencies&quot;: [   // 依赖管理
    &#123;
      &quot;name&quot;: &quot;SC&quot;,
      &quot;type&quot;: &quot;sc&quot;,
      &quot;compatible_versions&quot;: &quot;&gt;=1.5.1, &lt;2.0.0&quot;,
      &quot;incompatible_versions&quot;: [&quot;1.6.0&quot;, &quot;1.7.0&quot;],
      &quot;description&quot;: &quot;总控组件包&quot;
    &#125;,
    &#123;
      &quot;name&quot;: &quot;acl&quot;,    // 产品定义的组件英文简称
      &quot;description&quot;: &quot;ACL 插件包&quot;,
      &quot;type&quot;: &quot;plugin&quot;,
      &quot;incompatible_versions&quot;: [&quot;4.1.5&quot;],      
    &#125;
  ],
  &quot;proto_version&quot;: 1,
  &quot;changelog&quot;: &quot;This is the changelog content. \n- Added new features \n- Fixed bugs \n- Improved performance&quot;,
&#125;
</code></pre>
<ul>
<li><strong>Agent 示例</strong></li>
</ul>
<pre><code class="json">&#123;
  &quot;name&quot;: &quot;srfa&quot;,    // 产品定义的组件英文简称
  &quot;version&quot;: &quot;1.6.1&quot;,    // 发布版本号
  &quot;description&quot;: &quot;流量 Agent 组件包&quot;,
  &quot;type&quot;: &quot;agent&quot;,     // sc engine plugin agent
  &quot;checksum&quot;: &#123;
    &quot;v1&quot;: &quot;1234567890abcdef1234567890abcdef&quot;,   
  &#125;,
  &quot;dependencies&quot;: [   // 依赖管理
    &#123;
      &quot;name&quot;: &quot;srfm&quot;,   // 镜像引擎
      &quot;type&quot;: &quot;engine&quot;,
      &quot;compatible_versions&quot;: &quot;&gt;=1.5.1, &lt;2.0.0&quot;,
      &quot;incompatible_versions&quot;: [&quot;1.6.1&quot;],
      &quot;description&quot;: &quot;镜像引擎组件包&quot;
    &#125;,
  ],
  &quot;proto_version&quot;: 1,
  &quot;changelog&quot;: &quot;This is the changelog content. \n- Added new features \n- Fixed bugs \n- Improved performance&quot;,
&#125;
</code></pre>
<ul>
<li><strong>插件示例</strong></li>
</ul>
<pre><code class="json">&#123;
  &quot;name&quot;: &quot;acl&quot;,    // 产品定义的组件英文简称
  &quot;version&quot;: &quot;4.1.3&quot;,
  &quot;description&quot;: &quot;ACL 插件包&quot;,    // 界面上对于组件包信息描述
  &quot;type&quot;: &quot;plugin&quot;,     // sc engine plugin agent
  &quot;checksum&quot;: &#123;
    &quot;v1&quot;: &quot;1234567890abcdef1234567890abcdef&quot;,  
  &#125;,
  &quot;dependencies&quot;: [   // 依赖管理
    &#123;
      &quot;name&quot;: &quot;SE&quot;,
      &quot;type&quot;: &quot;engine&quot;,
      &quot;compatible_versions&quot;: &quot;&gt;=2.1.0, &lt;3.0.0&quot;,
      &quot;incompatible_versions&quot;: [&quot;2.1.2&quot;],
      &quot;description&quot;: &quot;引擎组件包&quot;
    &#125;,
    &#123;
      &quot;name&quot;: &quot;SC&quot;,
      &quot;type&quot;: &quot;sc&quot;,
      &quot;compatible_versions&quot;: &quot;&gt;=1.5.1, &lt;2.0.0&quot;,
      &quot;incompatible_versions&quot;: [&quot;1.6.0&quot;, &quot;1.7.0&quot;],
      &quot;description&quot;: &quot;总控组件包&quot;
    &#125;
  ],
  &quot;proto_version&quot;: 1,
  &quot;changelog&quot;: &quot;This is the changelog content. \n- Added new features \n- Fixed bugs \n- Improved performance&quot;,
&#125;
</code></pre>
<ul>
<li><strong>完整性校验机制机制</strong></li>
</ul>
<pre><code class="Bash"># 排除 meta.json 本身递归计算 目录下所有文件的 md5 值，注意，发布时要和导入校验时算法保持一致
find . -type f ! -name &#39;meta.json&#39; -exec md5sum &#123;&#125; + | awk &#39;&#123;print $1&#125;&#39;  | md5sum
</code></pre>
<h4 id="运行时信息"><a href="#运行时信息" class="headerlink" title="运行时信息"></a>运行时信息</h4><p>包含 二进制可执行文件，配置文件，内置脚本，等信息</p>
<h3 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h3><h2 id="组件包集"><a href="#组件包集" class="headerlink" title="组件包集"></a>组件包集</h2><h3 id="组件包集定义"><a href="#组件包集定义" class="headerlink" title="组件包集定义"></a>组件包集定义</h3><p>组件包集由多个组件包组成，软件交付时，大概率是多个组件包构建为一个组件包集给到用户，才能给用户完整的体验。</p>
<h3 id="结构和构建规则"><a href="#结构和构建规则" class="headerlink" title="结构和构建规则"></a>结构和构建规则</h3><p>组件包集文件名格式：20240618-SRBundle-batch.tar.gz，组件包集由多个组件包和一个名为 batch.json 的文件组成。batch.json 文件记录了每个组件包的校验和（checksum）值，用于验证组件包的完整性。组件包集的目录结构如下：</p>
<pre><code class="Text">SRBundle-batch/
├── SC_v1.0.0.tar.gz
├── SE_v2.0.0.tar.gz
├── acl_v3.0.0.tar.gz
├── install.sh
├── uninstall.sh
└── batch.json
</code></pre>
<p>batch.json</p>
<pre><code class="json">&#123;
  &quot;components&quot;: [
    &#123;
      &quot;name&quot;: &quot;SC_v1.0.0.tar.gz&quot;,
      &quot;checksum&quot;: &#123;
        &quot;v1&quot;: &quot;e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855&quot;,
      &#125;,
    &#125;,
    &#123;
      &quot;name&quot;: &quot;SE_v2.0.0.tar.gz&quot;,
      &quot;checksum&quot;: &#123;
        &quot;v1&quot;: &quot;abcde1234567890abcdef1234567890abcdef1234567890abcdef1234567890&quot; 
      &#125;,
    &#125;,
    &#123;
      &quot;name&quot;: &quot;acl_v3.0.0.tar.gz&quot;,
      &quot;checksum&quot;: &#123;
        &quot;v1&quot;: &quot;7890abcdef1234567890abcdef1234567890abcdef1234567890abcdef123456&quot; 
      &#125;,
    &#125;
  ],
  &quot;proto_version&quot;: &quot;1&quot;,
&#125;
</code></pre>
<h3 id="导入规则"><a href="#导入规则" class="headerlink" title="导入规则"></a>导入规则</h3><p>导入组件包集时，系统会首先读取 batch.json 文件并校验每个组件包的完整性。校验通过后，系统会开始导入每个组件包，执行相应的导入逻辑。导入过程如下：</p>
<ul>
<li>解压组件包集文件</li>
<li>读取并解析 batch.json 文件，校验每个组件包的完整性。</li>
<li>校验通过后，依次导入每个组件包，执行相应的导入逻辑。</li>
</ul>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="升级兼容问题"><a href="#升级兼容问题" class="headerlink" title="升级兼容问题"></a>升级兼容问题</h3><h4 id="1-5-总控如何适配新构建的组件包和组件包集"><a href="#1-5-总控如何适配新构建的组件包和组件包集" class="headerlink" title="1.5 总控如何适配新构建的组件包和组件包集"></a>1.5 总控如何适配新构建的组件包和组件包集</h4><ul>
<li><p>中间版本方案？<br>符合现有逻辑，有实现的可行性。决定做，现在开始开发中间版本，至少需要兼容新的导包逻辑，正常展示组件的交互接口</p>
</li>
<li><p>不兼容直接重装<br>如果有些存在服务彻底不兼容的情况，那就不做兼容逻辑。</p>
</li>
</ul>
<h3 id="组件包和组件包集信息遗漏"><a href="#组件包和组件包集信息遗漏" class="headerlink" title="组件包和组件包集信息遗漏"></a>组件包和组件包集信息遗漏</h3><h4 id="补充信息"><a href="#补充信息" class="headerlink" title="补充信息"></a>补充信息</h4><ul>
<li>发布方信息</li>
<li>发布时间</li>
</ul>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><h3 id="组件包安装脚本"><a href="#组件包安装脚本" class="headerlink" title="组件包安装脚本"></a>组件包安装脚本</h3><pre><code class="Bash"># 用户解压组件包
#tar zxvf SC_v1.0.0.tar.gz

./install.sh
</code></pre>
<h3 id="组件包集安装脚本"><a href="#组件包集安装脚本" class="headerlink" title="组件包集安装脚本"></a>组件包集安装脚本</h3><pre><code class="Bash"># 用户解压组件包集
# tar zxvf 20240618-SRBundle-batch.tar.gz
./install.sh
</code></pre>
<h4 id="构建工具（打包平台使用）"><a href="#构建工具（打包平台使用）" class="headerlink" title="构建工具（打包平台使用）"></a>构建工具（打包平台使用）</h4><p>生成 meta.json 后续可再开发或内嵌到打包平台中自动完成 </p>
<pre><code class="Bash">#!/bin/bash

# Function to prompt user for input
prompt() &#123;
  local var_name=$1
  local prompt_text=$2
  local default_value=$3
  read -p &quot;$prompt_text&quot; input
  eval $var_name=&quot;&#39;$&#123;input:-$default_value&#125;&#39;&quot;
&#125;

# Prompt for required fields
prompt name &quot;输入组件名 component name (required): &quot;
prompt type &quot;输入组件类型 component type (required) [sc/engine/plugin/agent]: &quot;
prompt version &quot;输入组件版本 the component version (required): &quot;
prompt checksum &quot;输出组件 md5 the checksum (MD5) (required): &quot;

# Start building the JSON structure
json_content=&quot;&#123;\n&quot;
json_content+=&quot;  \&quot;name\&quot;: \&quot;$name\&quot;,\n&quot;
json_content+=&quot;  \&quot;version\&quot;: \&quot;$version\&quot;,\n&quot;
json_content+=&quot;  \&quot;type\&quot;: \&quot;$type\&quot;,\n&quot;
json_content+=&quot;  \&quot;checksum\&quot;: &#123;\n&quot;
json_content+=&quot;    \&quot;v1\&quot;: \&quot;$checksum\&quot;\n&quot;
json_content+=&quot;  &#125;&quot;

# Prompt for optional fields
read -p &quot;新增 description? (y/n): &quot; add_description
if [[ $add_description == &quot;y&quot; ]]; then
  prompt description &quot;Enter the description: &quot;
  json_content+=&quot;,\n  \&quot;description\&quot;: \&quot;$description\&quot;&quot;
fi

# Prompt for dependencies
read -p &quot;新增 dependencies? (y/n): &quot; add_dependencies
if [[ $add_dependencies == &quot;y&quot; ]]; then
  dependencies=&quot;[]&quot;
  while : ; do
    read -p &quot;Add a dependency? (y/n): &quot; add_dependency
    if [[ $add_dependency != &quot;y&quot; ]]; then
      break
    fi
    prompt dep_name &quot;Enter the dependency name: &quot;
    prompt dep_type &quot;Enter the dependency type [sc/engine/plugin/agent]: &quot;
    prompt dep_compatible_versions &quot;输入 compatible versions: &quot;
    prompt dep_incompatible_versions &quot;输入 incompatible versions (使用 , 隔开 如：&gt;=1.5.1, &lt;2.0.0): &quot;
    prompt dep_description &quot;输入依赖描述 ：&quot;

    # Add the dependency to the dependencies array
    dependency=&quot;&#123;\&quot;name\&quot;: \&quot;$dep_name\&quot;, \&quot;type\&quot;: \&quot;$dep_type\&quot;, \&quot;compatibleVersions\&quot;: \&quot;$dep_compatible_versions\&quot;, \&quot;incompatibleVersions\&quot;: [$(echo $dep_incompatible_versions | sed &#39;s/,/&quot;,&quot;/g&#39; | sed &#39;s/^/&quot;/&#39; | sed &#39;s/$/&quot;/&#39;)], \&quot;description\&quot;: \&quot;$dep_description\&quot;&#125;&quot;
    if [[ $dependencies == &quot;[]&quot; ]]; then
      dependencies=&quot;[$dependency]&quot;
    else
      dependencies=$(echo $dependencies | sed &#39;s/]$/,&#39;&quot;$&#123;dependency&#125;&quot;&#39;]/&#39;)
    fi
  done
  json_content+=&quot;,\n  \&quot;dependencies\&quot;: $dependencies&quot;
fi

json_content+=&quot;,\n  \&quot;protoVersion\&quot;: 1\n&quot;

# Prompt for changelog content
echo &quot;请输入 changelog 内容 (结束输入使用 Ctrl+D):&quot;
changelog=$(&lt;/dev/stdin)
json_content+=&quot;,\n  \&quot;changelog\&quot;: \&quot;$changelog\&quot;\n&quot;

json_content+=&quot;&#125;&quot;

echo -e $json_content &gt; meta.json

echo &quot;meta.json has been created with the provided information.&quot;
</code></pre>
<p>生成 batch.json</p>
<pre><code class="Bash">#!/bin/bash

calculate_checksum() &#123;
  local file=$1
  md5sum &quot;$file&quot; | awk &#39;&#123; print $1 &#125;&#39;
&#125;

json_content=&quot;&#123;\n&quot;
json_content+=&quot;  \&quot;components\&quot;: [\n&quot;

# 找到 tar.gz 后缀文件
first=true
for file in *.tar.gz; do
  if [[ -f &quot;$file&quot; ]]; then
    # Calculate the checksum
    checksum=$(calculate_checksum &quot;$file&quot;)

    if $first; then
      first=false
    else
      json_content+=&quot;,\n&quot;
    fi

    json_content+=&quot;    &#123;\n&quot;
    json_content+=&quot;      \&quot;name\&quot;: \&quot;$file\&quot;,\n&quot;
    json_content+=&quot;      \&quot;checksum\&quot;: &#123;\n&quot;
    json_content+=&quot;        \&quot;v1\&quot;: \&quot;$checksum\&quot;\n&quot;
    json_content+=&quot;      &#125;\n&quot;
    json_content+=&quot;    &#125;&quot;
  fi
done

json_content+=&quot;\n  ],\n&quot;
json_content+=&quot;  \&quot;protoVersion\&quot;: 1\n&quot;
json_content+=&quot;&#125;&quot;

echo -e $json_content &gt; batch.json

echo &quot;batch.json has been created with the checksums of all .tar.gz files in the current directory.&quot;
</code></pre>
<h4 id="导入接口-golang-kit"><a href="#导入接口-golang-kit" class="headerlink" title="导入接口 golang-kit"></a>导入接口 golang-kit</h4><p>解析 meta.json 文件内容，校验包完整性后，再保存基本信息，版本更新日志，依赖关系。</p>
<pre><code class="Go">package main

import (
    &quot;archive/tar&quot;
    &quot;compress/gzip&quot;
    &quot;encoding/json&quot;
    &quot;io&quot;
    &quot;io/ioutil&quot;
    &quot;log&quot;
    &quot;os&quot;
    &quot;os/exec&quot;
    &quot;path/filepath&quot;
    &quot;strings&quot;

    _ &quot;github.com/go-sql-driver/mysql&quot;
    &quot;xorm.io/xorm&quot;
)

// ComponentBall represents the structure of the meta.json file and changelog.md combined
type ComponentBall struct &#123;
    ID               int64        `xorm:&quot;pk autoincr&quot; json:&quot;id&quot;`
    Name             string       `json:&quot;name&quot;`
    Version          string       `json:&quot;version&quot;`
    Description      string       `json:&quot;description,omitempty&quot;`
    Type             string       `json:&quot;type&quot;`
    Checksum         string       `json:&quot;checksum&quot;`
    Dependencies     string       `json:&quot;dependencies,omitempty&quot;` // Store dependencies as JSON string
    ProtoVersion     int          `json:&quot;protoVersion&quot;`
    Changelog        string       `xorm:&quot;TEXT&quot; json:&quot;changelog&quot;`
    DependenciesList []Dependency `json:&quot;dependenciesList&quot; xorm:&quot;-&quot;`
&#125;

// Meta represents the structure of the meta.json file
type Meta struct &#123;
    Name         string       `json:&quot;name&quot;`
    Version      string       `json:&quot;version&quot;`
    Description  string       `json:&quot;description,omitempty&quot;`
    Type         string       `json:&quot;type&quot;`
    Checksum     Checksum     `json:&quot;checksum&quot;`
    Dependencies []Dependency `json:&quot;dependencies,omitempty&quot;`
    ProtoVersion int          `json:&quot;protoVersion&quot;`
    Changelog    string       `json:&quot;changelog&quot;`
&#125;

// Checksum represents the checksum structure
type Checksum struct &#123;
    V1 string `json:&quot;v1&quot;`
&#125;

// Dependency represents a dependency in the meta.json file
type Dependency struct &#123;
    Name                 string   `json:&quot;name&quot;`
    Type                 string   `json:&quot;type&quot;`
    CompatibleVersions   string   `json:&quot;compatibleVersions&quot;`
    IncompatibleVersions []string `json:&quot;incompatibleVersions&quot;`
    Description          string   `json:&quot;description&quot;`
&#125;

// validateChecksum validates the checksum of the extracted files
func validateChecksum(extractedDir string, expectedChecksum string) bool &#123;
    cmd := exec.Command(&quot;bash&quot;, &quot;-c&quot;, &quot;find . -type f ! -name &#39;meta.json&#39; -exec md5sum &#123;&#125; + | awk &#39;&#123;print $1&#125;&#39; | md5sum&quot;)
    cmd.Dir = extractedDir
    output, err := cmd.Output()
    if err != nil &#123;
        log.Printf(&quot;Error executing checksum validation command: %v&quot;, err)
        return false
    &#125;

    actualChecksumLs := strings.Fields(string(output))
    if len(actualChecksumLs) &lt; 2 &#123;
        log.Println(&quot;Error executing command:&quot;, err)
    &#125;
    actualChecksum := actualChecksumLs[0]
    return actualChecksum == expectedChecksum
&#125;

// extractTarGz extracts a tar.gz file to a specified directory
func extractTarGz(gzipStream io.Reader, dst string) error &#123;
    uncompressedStream, err := gzip.NewReader(gzipStream)
    if err != nil &#123;
        return err
    &#125;
    defer uncompressedStream.Close()

    tarReader := tar.NewReader(uncompressedStream)
    for &#123;
        header, err := tarReader.Next()
        if err == io.EOF &#123;
            break
        &#125;
        if err != nil &#123;
            return err
        &#125;

        target := filepath.Join(dst, header.Name)
        switch header.Typeflag &#123;
        case tar.TypeDir:
            if err := os.MkdirAll(target, os.FileMode(header.Mode)); err != nil &#123;
                return err
            &#125;
        case tar.TypeReg:
            f, err := os.OpenFile(target, os.O_CREATE|os.O_RDWR, os.FileMode(header.Mode))
            if err != nil &#123;
                return err
            &#125;
            if _, err := io.Copy(f, tarReader); err != nil &#123;
                return err
            &#125;
            f.Close()
        &#125;
    &#125;
    return nil
&#125;

// saveComponent saves the parsed component information to the database
func saveComponent(engine *xorm.Engine, component ComponentBall) error &#123;
    session := engine.NewSession()
    defer session.Close()

    err := session.Begin()
    if err != nil &#123;
        return err
    &#125;

    _, err = session.Insert(&amp;component)
    if err != nil &#123;
        session.Rollback()
        return err
    &#125;

    return session.Commit()
&#125;

func ImportComponent() error &#123;
    packageFile := &quot;SC_v1.5.15.linux-x86_64.tar.gz&quot;
    extractedDir := &quot;SC_v1.5.15.linux-x86_64&quot;
    err := os.MkdirAll(extractedDir, os.ModePerm)
    if err != nil &#123;
        return err
    &#125;

    file, err := os.Open(packageFile)
    if err != nil &#123;
        log.Fatalf(&quot;Error opening package file: %v&quot;, err)
        return err
    &#125;
    defer file.Close()

    err = extractTarGz(file, extractedDir)
    if err != nil &#123;
        log.Fatalf(&quot;Error extracting package file: %v&quot;, err)
        return err
    &#125;

    metaFile := filepath.Join(extractedDir, &quot;meta.json&quot;)
    metaData, err := ioutil.ReadFile(metaFile)
    if err != nil &#123;
        log.Fatalf(&quot;Error reading meta.json: %v&quot;, err)
        return err
    &#125;

    // Parse meta.json content
    var meta Meta
    err = json.Unmarshal(metaData, &amp;meta)
    if err != nil &#123;
        log.Fatalf(&quot;Error parsing meta.json: %v&quot;, err)
        return err
    &#125;

    // Validate package integrity
    if !validateChecksum(extractedDir, meta.Checksum.V1) &#123;
        log.Fatalf(&quot;Package integrity validation failed for %s&quot;, packageFile)
        return err
    &#125;

    // Convert dependencies to JSON string for storage
    dependenciesJSON, err := json.Marshal(meta.Dependencies)
    if err != nil &#123;
        log.Fatalf(&quot;Error marshaling dependencies: %v&quot;, err)
        return err
    &#125;

    // Create component struct
    component := ComponentBall&#123;
        Name:             meta.Name,
        Version:          meta.Version,
        Description:      meta.Description,
        Type:             meta.Type,
        Checksum:         meta.Checksum.V1,
        Dependencies:     string(dependenciesJSON),
        ProtoVersion:     meta.ProtoVersion,
        Changelog:        meta.Changelog,
        DependenciesList: meta.Dependencies,
    &#125;

    // Connect to the database
    dbURL := &quot;user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8&amp;parseTime=True&quot;
    engine, err := xorm.NewEngine(&quot;mysql&quot;, dbURL)
    if err != nil &#123;
        log.Fatalf(&quot;Error connecting to the database: %v&quot;, err)
        return err
    &#125;

    // Save component information to the database
    err = saveComponent(engine, component)
    if err != nil &#123;
        log.Fatalf(&quot;Error saving component information to the database: %v&quot;, err)
        return err
    &#125;

    log.Println(&quot;Parsed component information saved to the database successfully.&quot;)
    return nil
&#125;

func main() &#123;
    err := ImportComponent()
    if err != nil &#123;
        log.Fatalf(&quot;Error importing component: %v&quot;, err)
    &#125;
&#125;

</code></pre>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 Xiaoy
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;xiaoy
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
