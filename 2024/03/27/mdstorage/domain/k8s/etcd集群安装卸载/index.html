
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>etcd集群安装卸载.md | Xiaoy</title>
    <meta name="author" content="xiaoy" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>XIAOY</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;XIAOY</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>etcd集群安装卸载.md</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/3/27
        </span>
        
        <span class="category">
            <a href="/categories/domain/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                domain
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/etcd/" style="color: #ffa2c4">
                    etcd
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/cluster/" style="color: #03a9f4">
                    cluster
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h2 id="集群安装脚本"><a href="#集群安装脚本" class="headerlink" title="集群安装脚本"></a>集群安装脚本</h2><pre><code class="bash"># 函数：创建必要的目录结构
create_directories() &#123;
    mkdir -p &quot;$@&quot;
&#125;

# 创建etcd配置文件
create_etcd_config() &#123;
  local config_file=$1
  local node_name=$2
  local data_dir=$3
  local wal_dir=$4
  local client_url=$5
  local peer_url=$6
    local cluster_token=$7
    local cluster=$8
    local new_opt=$&#123;9&#125;
  
  cat &lt;&lt; EOF &gt; &quot;$config_file&quot;
ETCD_OPTS=&quot;--name $node_name \\
--max-request-bytes 10485760 \\
--data-dir $data_dir \\
--wal-dir $wal_dir \\
--advertise-client-urls $client_url \\
--listen-client-urls $client_url \\
--listen-peer-urls $peer_url \\
--initial-advertise-peer-urls $peer_url \\
--initial-cluster-token $&#123;cluster_token&#125; \\
--initial-cluster $&#123;cluster&#125; \\
--initial-cluster-state $&#123;new_opt&#125;&quot;
EOF
&#125;

reload_and_start_etcd() &#123;
  systemctl daemon-reload
  systemctl start etcd
&#125;

# 函数：配置并启动etcd服务
create_etcd_service() &#123;
  local service_file=$1
  local config_path=$2
  local etcd_executable=$3
  
  cat &lt;&lt; EOF &gt; &quot;$service_file&quot;
[Unit]
Description=Etcd For Kubernetes
Wants=network-online.target
After=network.target network-online.target

[Service]
EnvironmentFile=$config_path
ExecStart=$etcd_executable \$ETCD_OPTS
Restart=always

[Install]
WantedBy=multi-user.target
EOF
&#125;

get_etcd_from_local() &#123;
  local source_path=$1
  local target_dir=$2

  if [ ! -f &quot;$source_path&quot; ]; then
    echo &quot;Source etcd binary does not exist at $&#123;source_path&#125;.&quot;
    exit 1
  fi

  echo &quot;Copying etcd binary from $&#123;source_path&#125; to $&#123;target_dir&#125;...&quot;
  if cp &quot;$source_path&quot; &quot;$&#123;target_dir&#125;/etcd&quot;; then
    chmod +x &quot;$&#123;target_dir&#125;/etcd&quot;
    echo &quot;Successfully copied and prepared etcd binary.&quot;
  else
    echo &quot;Failed to copy etcd binary from $&#123;source_path&#125;.&quot;
    exit 1
  fi
&#125;

get_etcd_from_remote() &#123;
  local bin_dir=$1
  local ftpserver=$2
  local http_user=$3
  local http_passwd=$4

  echo &quot;Downloading etcd binary from $&#123;ftpserver&#125;...&quot;
  if wget -P &quot;$bin_dir&quot; --http-user=&quot;$http_user&quot; --http-passwd=&quot;$http_passwd&quot; &quot;$&#123;ftpserver&#125;/repo/kubernetes/etcd&quot;; then
    chmod +x &quot;$&#123;bin_dir&#125;/etcd&quot;
    echo &quot;Successfully downloaded and prepared etcd binary.&quot;
  else
    echo &quot;Failed to download etcd binary from $&#123;ftpserver&#125;.&quot;
    exit 1
  fi
&#125;

get_etcd() &#123;
  local option=$1
  local target_dir=$2
  local source_path_or_url=$3
  local http_user=$4 # 仅 remote 时需要
  local http_passwd=$5 # 仅 remote 时需要

  case &quot;$option&quot; in
    &quot;local&quot;)
      get_etcd_from_local &quot;$source_path_or_url&quot; &quot;$target_dir&quot;
      ;;
    &quot;remote&quot;)
      get_etcd_from_remote &quot;$target_dir&quot; &quot;$source_path_or_url&quot; &quot;$http_user&quot; &quot;$http_passwd&quot;
      ;;
    *)
      echo &quot;Invalid option: $option. Please choose &#39;local&#39; or &#39;remote&#39;.&quot;
      exit 1
      ;;
  esac
&#125;

list_etcd_members() &#123;
  local server_url=$1

  # todo --user --cert --key 
  curl -X POST &quot;$&#123;server_url&#125;/v3/cluster/member/list&quot; \
    -H &quot;Content-Type: application/json&quot; \
    -d &#39;&#123;&#125;&#39;
&#125;

add_etcd_member_by_curl() &#123;
  local server_url=$1
  local peer_url=$2

  # 构造请求体
  local data=$(cat &lt;&lt;EOF
&#123;
  &quot;peerURLs&quot;: [&quot;$peer_url&quot;]
&#125;
EOF
)

  # 发送请求
  curl -X POST &quot;$&#123;server_url&#125;/v3/cluster/member/add&quot; \
       -H &quot;Content-Type: application/json&quot; \
       -d &quot;$data&quot;
&#125;


# 主函数：安装etcd集群节点
install_etcd_cluster_node() &#123;
  local node_name=$1
  local node_ip=$2
  local cluster_ips=$3
    local new_opt=$4

  local data_dir=&quot;/opt/k8s/data&quot;
  local wal_dir=&quot;/opt/k8s/wal&quot;
  local bin_dir=&quot;/opt/k8s/bin&quot;
  local work_dir=&quot;/opt/k8s/work&quot;
  local ftpserver=&quot;http://119.91.145.27:12800&quot;
  local http_user=&quot;team&quot;
  local http_passwd=&quot;xdmybl&quot;
  local config_file=&quot;$&#123;work_dir&#125;/etcd.conf&quot;
  local service_file=&quot;/lib/systemd/system/etcd.service&quot;
  local etcd_executable=&quot;$&#123;bin_dir&#125;/etcd&quot;
    local etcd_src_path=&quot;/opt/etcd&quot;
    local cluster_gs=&quot;cluster_token1&quot;

    local client_url=&quot;http://$&#123;node_ip&#125;:2379&quot;
    local listen_peer_url=&quot;http://$&#123;node_ip&#125;:2380&quot;

  # 创建所需目录
  create_directories &quot;$data_dir&quot; &quot;$wal_dir&quot; &quot;$bin_dir&quot; &quot;$work_dir&quot;

  create_etcd_config &quot;$config_file&quot; &quot;$node_name&quot; &quot;$data_dir&quot; &quot;$wal_dir&quot; &quot;$client_url&quot; &quot;$&#123;listen_peer_url&#125;&quot; &quot;$&#123;cluster_gs&#125;&quot; &quot;$&#123;cluster_ips&#125;&quot; $&#123;new_opt&#125;
    
  create_etcd_service &quot;$service_file&quot; &quot;$config_file&quot; &quot;$etcd_executable&quot;	
  # 下载etcd二进制文件
    get_etcd &quot;local&quot; &quot;$bin_dir&quot; &quot;$etcd_src_path&quot;
  reload_and_start_etcd
  # 配置并启动etcd服务
&#125;

extract_hosts_to_cluster_info() &#123;
                local hosts_file=$1
                local cluster_info=$(awk &#39;/^\s*[^#]/ &amp;&amp; $2 ~ /.srhino.svc.local$/ &amp;&amp; $2 !~ /^s/ &amp;&amp; $2 !~ /^localhost/ &#123;sub(/\.srhino\.svc\.local$/, &quot;&quot;, $2); print $2&quot;=http://&quot;$1&quot;:2380&quot;&#125;&#39; $&#123;hosts_file&#125; | paste -sd,)
                echo $cluster_info
&#125;
</code></pre>
<h3 id="安装三节点（建立三节点），适用于创建集群时，直接声明集群三节点"><a href="#安装三节点（建立三节点），适用于创建集群时，直接声明集群三节点" class="headerlink" title="安装三节点（建立三节点），适用于创建集群时，直接声明集群三节点"></a>安装三节点（建立三节点），适用于创建集群时，直接声明集群三节点</h3><h4 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h4><pre><code class="mermaid">sequenceDiagram
    participant Manager as Manager
    participant Node1 as node1
    participant Node2 as node2
    participant Node3 as node3

    par 建立新集群
        Manager-&gt;&gt;Node1: new cluster: node1, node2, node3
        Manager-&gt;&gt;Node2: new cluster: node1, node2, node3
        Manager-&gt;&gt;Node3: new cluster: node1, node2, node3
    and 相应节点响应
        Node1--&gt;&gt;Manager: 响应
        Node2--&gt;&gt;Manager: 响应
        Node3--&gt;&gt;Manager: 响应
    end
    Note over Manager,Node3: etcd 初始集群建立完成

</code></pre>
<pre><code class="bash">#!/bin/bash

# 并发执行三节点安装
ssh -n root@192.168.122.26 &quot;cd /opt &amp;&amp; ./install_cluster.sh&quot; &amp;
ssh -n root@192.168.122.35 &quot;cd /opt &amp;&amp; ./install_cluster.sh&quot; &amp;
ssh -n root@192.168.122.238 &quot;cd /opt &amp;&amp; ./install_cluster.sh&quot; &amp;

wait
</code></pre>
<pre><code class="bash">#!/bin/bash

source ./install_cluster_lib.sh 
# first node param
#local_ip=&quot;ouryun.node2.com&quot;
local_ip=&quot;192.168.122.26&quot;
local_host=&quot;node1&quot;
# 三节点都需要是 new
new_opt=&quot;new&quot;
# 这里包含集群信息
cluster_info=&quot;node1=http://192.168.122.26:2380,node2=http://192.168.122.35:2380,node3=http://192.168.122.237:2380&quot;

# 使用示例
# install_etcd_cluster_node &quot;node1&quot; &quot;192.168.1.1&quot; &quot;node1=http://192.168.1.1:2380,node2=http://192.168.1.2:2380,node3=http://192.168.1.3:2380&quot;
install_etcd_cluster_node $local_host $local_ip &quot;$&#123;cluster_info&#125;&quot;  $&#123;new_opt&#125;
</code></pre>
<h3 id="安装三节点（先创建一个节点的集群，再加入-node2-，再加入-node3），适用于往已有集群加入新节点"><a href="#安装三节点（先创建一个节点的集群，再加入-node2-，再加入-node3），适用于往已有集群加入新节点" class="headerlink" title="安装三节点（先创建一个节点的集群，再加入 node2 ，再加入 node3），适用于往已有集群加入新节点"></a>安装三节点（先创建一个节点的集群，再加入 node2 ，再加入 node3），适用于往已有集群加入新节点</h3><h4 id="时序图-1"><a href="#时序图-1" class="headerlink" title="时序图"></a>时序图</h4><pre><code class="mermaid">sequenceDiagram
    participant manager as Manager
    participant Node1 as node1
    participant Node2 as node2
    participant Node3 as node3


    manager-&gt;&gt;Node1: 建立集群
    activate Node1
    Node1-&gt;&gt;Node1: new cluster node1
    Node1--&gt;&gt;manager: 
    deactivate Node1
    
    manager-&gt;&gt;Node2: 新增节点2
    activate Node2
    Note over Node1,Node2: 环境变量中 cluster: node1,node2
    Node2-&gt;&gt;Node1: member add node2
    Node1--&gt;&gt;Node2: 
    Node2-&gt;&gt;Node2: node2 start （existing cluster, cluster: node1,node2）
    Node2--&gt;&gt;manager: 
    deactivate Node2
    
    manager-&gt;&gt;Node3: 新增节点3
    activate Node3
    Note over Node1,Node3: 环境变量中 cluster: node1,node2,node3
    alt request endpoints
        Node3-&gt;&gt;Node1: member add node3
        Node1--&gt;&gt;Node3: 
    else
        Node3-&gt;&gt;Node2: member add node3
        Node2--&gt;&gt;Node3: 
    end
    Node3-&gt;&gt;Node3: node3 start（existing cluster, cluster: node1,node2,node3）
    Node3--&gt;&gt;manager: 响应
    deactivate Node3
</code></pre>
<pre><code class="bash"># install_etcd_first.sh
#!/bin/bash

source ./install_cluster_lib.sh 
# first node param
local_ip=&quot;192.168.122.26&quot;
local_host=&quot;node1&quot;
new_opt=&quot;new&quot;
# 这里包含集群信息
existing_node_info=&quot;&quot;

# 使用示例
# install_etcd_cluster_node &quot;node1&quot; &quot;192.168.1.1&quot; &quot;node1=http://192.168.1.1:2380,node2=http://192.168.1.2:2380,node3=http://192.168.1.3:2380&quot;

install_etcd_cluster_node $local_host $local_ip &quot;$&#123;local_host&#125;=http://$&#123;local_ip&#125;:2380&quot; $&#123;new_opt&#125;
</code></pre>
<pre><code class="bash"># install_etcd_other.sh

# other node param

source ./install_cluster_lib.sh 

local_ip=&quot;192.168.122.35&quot;
local_host=&quot;node2&quot;
new_opt=&quot;existing&quot;
existing_node_info=&quot;node1=http://192.168.122.26:2380&quot;

# 使用示例
# install_etcd_cluster_node &quot;node1&quot; &quot;192.168.1.1&quot; &quot;node1=http://192.168.1.1:2380,node2=http://192.168.1.2:2380,node3=http://192.168.1.3:2380&quot;
install_etcd_cluster_node $local_host $local_ip &quot;$&#123;existing_node_info&#125;,$&#123;local_host&#125;=http://$&#123;local_ip&#125;:2380&quot; $&#123;new_opt&#125;
</code></pre>
<h3 id="新增集群节点"><a href="#新增集群节点" class="headerlink" title="新增集群节点"></a>新增集群节点</h3><pre><code class="bash"># member_add_by_etcdctl.sh
# 新增集群
member_add_by_etcdctl() &#123;
  local new_member_name=$1
  local new_member_peer_url=$2
  local existing_member_client_urls=$3

  # 设置ETCDCTL_API版本，确保使用v3 API
  export ETCDCTL_API=3

  # 添加新成员到集群
  etcdctl --endpoints=&quot;$&#123;existing_member_client_urls&#125;&quot; \
    member add &quot;$&#123;new_member_name&#125;&quot; \
    --peer-urls=&quot;$&#123;new_member_peer_url&#125;&quot;

  # 检查命令执行的退出状态
  if [ $? -eq 0 ]; then
    echo &quot;Member $&#123;new_member_name&#125; successfully added to the cluster.&quot;
  else
    echo &quot;Failed to add member $&#123;new_member_name&#125; to the cluster.&quot;
    exit 1
  fi
&#125;

# member_id=&quot;node2&quot;
# member_url=&quot;http://192.168.122.35:2380&quot;
# access_endpoint_url=&quot;http://192.168.122.26:2379&quot;

# # 新增集群成员
# member_add &quot;node2&quot; &quot;http://192.168.122.35:2380&quot; &quot;http://192.168.122.26:2379&quot;
member_id=&quot;node3&quot;
member_url=&quot;http://192.168.122.237:2380&quot;
access_endpoint_url=&quot;http://192.168.122.26:2379&quot;

# 新增集群成员
member_add_by_etcdctl $&#123;member_id&#125; $&#123;member_url&#125; $&#123;access_endpoint_url&#125;
</code></pre>
<h2 id="卸载-etcd"><a href="#卸载-etcd" class="headerlink" title="卸载 etcd"></a>卸载 etcd</h2><pre><code class="bash"># uninstall_etcd.sh

#!/bin/bash

# 停止etcd服务
stop_etcd_service() &#123;
  echo &quot;Stopping etcd service...&quot;
  systemctl stop etcd
&#125;

# 禁用etcd服务
disable_etcd_service() &#123;
  echo &quot;Disabling etcd service...&quot;
  systemctl disable etcd
&#125;

# 删除etcd服务文件
remove_etcd_service_file() &#123;
  echo &quot;Removing etcd service file...&quot;
  rm -f /lib/systemd/system/etcd.service
&#125;

# 重新加载systemd守护进程
reload_systemd() &#123;
  echo &quot;Reloading systemd daemon...&quot;
  systemctl daemon-reload
&#125;

# 删除etcd二进制文件和数据目录
cleanup_etcd_files() &#123;
  local bin_dir=&quot;/opt/k8s/bin&quot;
  local data_dir=&quot;/opt/k8s/data&quot;
  local wal_dir=&quot;/opt/k8s/wal&quot;
  local work_dir=&quot;/opt/k8s/work&quot;

  echo &quot;Cleaning up etcd binary and data directories...&quot;
  rm -f &quot;$&#123;bin_dir&#125;/etcd&quot;
  rm -rf &quot;$data_dir&quot;
  rm -rf &quot;$wal_dir&quot;
  rm -rf &quot;$work_dir&quot;
&#125;

# 卸载etcd的主函数
uninstall_etcd() &#123;
  stop_etcd_service
  disable_etcd_service
  remove_etcd_service_file
  reload_systemd
  cleanup_etcd_files
  
  echo &quot;etcd has been successfully uninstalled.&quot;
&#125;

# 执行卸载
uninstall_etcd
</code></pre>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 Xiaoy
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;xiaoy
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
