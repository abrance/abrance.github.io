
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>etcd和apiserver生命周期管理.md | Xiaoy</title>
    <meta name="author" content="xiaoy" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>XIAOY</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;XIAOY</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>etcd和apiserver生命周期管理.md</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/3/19
        </span>
        
        <span class="category">
            <a href="/categories/domain/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                domain
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/apiserver/" style="color: #03a9f4">
                    apiserver
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/etcd/" style="color: #00bcd4">
                    etcd
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/kubernetes/" style="color: #ff7d73">
                    kubernetes
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h2 id="etcd-安装脚本"><a href="#etcd-安装脚本" class="headerlink" title="etcd 安装脚本"></a>etcd 安装脚本</h2><pre><code class="bash">set -ex


ftpserver=http://119.91.145.27:12800
mkdir -p /opt/k8s/wal /opt/k8s/data /opt/k8s/bin /opt/k8s/work

cat &lt;&lt; EOF &gt; /opt/k8s/work/etcd.conf
ETCD_OPTS=&quot;--name node1 \\
--max-request-bytes 10485760 \\
--data-dir /opt/k8s/data \\
--wal-dir /opt/k8s/wal \\
--advertise-client-urls http://127.0.0.1:2379 \\
--listen-client-urls http://127.0.0.1:2379 \\
--listen-peer-urls http://127.0.0.1:2380&quot;
EOF

cat &lt;&lt; EOF &gt; /lib/systemd/system/etcd.service
[Unit]
Description=Etcd For Kubernetes
Wants=network-online.target
After=network.target network-online.target

[Service]
EnvironmentFile=/opt/k8s/work/etcd.conf
ExecStart=/opt/k8s/bin/etcd $ETCD_OPTS
Restart=always

[Install]
WantedBy=multi-user.target
EOF

wget -P /opt/k8s/bin/ --http-user=team  --http-passwd=xdmybl $&#123;ftpserver&#125;/repo/kubernetes/etcd
chmod +x /opt/k8s/bin/etcd
systemctl daemon-reload
systemctl start etcd
</code></pre>
<h2 id="apiserver-安装脚本"><a href="#apiserver-安装脚本" class="headerlink" title="apiserver 安装脚本"></a>apiserver 安装脚本</h2><pre><code class="bash">#!/bin/bash

# 安装 apiserver 的脚本(包括 etcd 的安装)
# 单台机器架构 ( 单节点 etcd 单台 apiserver )

# 判断是否存在 etcd, 没有则安装
unit_name=etcd
if  systemctl list-unit-files | grep -q &quot;^$unit_name&quot; ; then
  echo &quot;$unit_name exists&quot;
else
  echo &quot;$unit_name does not exist&quot;
  ./install_etcd.sh
fi

# 假设 etcd 是监听 127.0.0.1:2379 2380

# 需要填apiserver 的监听地址
LOCALIP=127.0.0.1


#------------------------------------------------------------
# wget
ftp_server=http://119.91.145.27:12800

mkdir -p /opt/k8s &amp;&amp; cd /opt/k8s
wget --http-user=team  --http-passwd=xdmybl $&#123;ftp_server&#125;/kubernetes/kube-apiserver
wget --http-user=team  --http-passwd=xdmybl $&#123;ftp_server&#125;/kubernetes/kubectl
chmod +x kubectl &amp;&amp; chmod +x kube-apiserver
# 链接
ln -s $&#123;PWD&#125;/kubectl /usr/local/bin/
# 需要空格
cat &gt;&gt; /etc/profile &lt;&lt; EOF

alias k=&quot;kubectl&quot;

EOF
#------------------------------------------------------------

# 生成 证书
#------------------------------------------------------------
# 获取 cfssl 在 ./bin目录下
ftp_server=http://119.91.145.27:12800

mkdir -p /opt/k8s/work &amp;&amp; cd /opt/k8s
wget --http-user=team  --http-passwd=xdmybl  $&#123;ftp_server&#125;/kubernetes/cfssl/cfssl_linux-amd64
wget --http-user=team  --http-passwd=xdmybl  $&#123;ftp_server&#125;/kubernetes/cfssl/cfssljson_linux-amd64
mv cfssl_linux-amd64 cfssl &amp;&amp; chmod +x cfssl
mv cfssljson_linux-amd64 cfssljson &amp;&amp; chmod +x cfssljson
ln -s $&#123;PWD&#125;/cfssl /usr/local/bin
ln -s $&#123;PWD&#125;/cfssljson /usr/local/bin

# 创建 logs 目录
mkdir -p /opt/k8s/logs

cd work
# 需要
# ca-csr.json
# ca-config.json
# server-csr.json
# admin-csr.json 用于生成 kubectl admin 用户 kubeconfig

# 生成 ca-csr.json
cat &lt;&lt; EOF &gt;&gt; ca-csr.json
&#123;
  &quot;CN&quot;: &quot;kubernetes&quot;,
  &quot;hosts&quot;: [
    &quot;$LOCALIP&quot;,
    &quot;kubernetes&quot;,
    &quot;kubernetes.default&quot;,
    &quot;kubernetes.default.svc&quot;,
    &quot;kubernetes.default.svc.cluster&quot;,
    &quot;kubernetes.default.svc.cluster.local.&quot;
  ],
  &quot;key&quot;: &#123;
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  &#125;,
  &quot;names&quot;: [
    &#123;
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Shanghai&quot;,
      &quot;L&quot;: &quot;Shanghai&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    &#125;
  ]
&#125;
EOF

# ca-config.json
cat &lt;&lt; EOF &gt;&gt; ca-config.json
&#123;
  &quot;signing&quot;: &#123;
    &quot;default&quot;: &#123;
      &quot;expiry&quot;: &quot;87600h&quot;
    &#125;,
    &quot;profiles&quot;: &#123;
      &quot;kubernetes&quot;: &#123;
         &quot;expiry&quot;: &quot;87600h&quot;,
         &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ]
      &#125;
    &#125;
  &#125;
&#125;
EOF

cat &lt;&lt; EOF &gt; server-csr.json
&#123;
  &quot;CN&quot;: &quot;kubernetes&quot;,
  &quot;hosts&quot;: [
    &quot;$LOCALIP&quot;,
    &quot;kubernetes&quot;,
    &quot;kubernetes.default&quot;,
    &quot;kubernetes.default.svc&quot;,
    &quot;kubernetes.default.svc.cluster&quot;,
    &quot;kubernetes.default.svc.cluster.local.&quot;
  ],
  &quot;key&quot;: &#123;
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  &#125;,
  &quot;names&quot;: [
    &#123;
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;Shanghai&quot;,
      &quot;L&quot;: &quot;Shanghai&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    &#125;
  ]
&#125;
EOF

cat &lt;&lt; EOF &gt; admin-csr.json
&#123;
  &quot;CN&quot;: &quot;admin&quot;,
  &quot;hosts&quot;: [
    &quot;$LOCALIP&quot;,
    &quot;kubernetes&quot;,
    &quot;kubernetes.default&quot;,
    &quot;kubernetes.default.svc&quot;,
    &quot;kubernetes.default.svc.cluster&quot;,
    &quot;kubernetes.default.svc.cluster.local.&quot;
  ],
  &quot;key&quot;: &#123;
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  &#125;,
  &quot;names&quot;: [
    &#123;
      &quot;C&quot;: &quot;CN&quot;,
      &quot;O&quot;: &quot;system:masters&quot;,
      &quot;OU&quot;: &quot;System&quot;,
      &quot;L&quot;: &quot;Shanghai&quot;,
      &quot;ST&quot;: &quot;Shanghai&quot;
    &#125;
  ]
&#125;
EOF

# 签发 ca
cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
# 签发 apiserver 证书
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server
# 签发 admin 用户证书，绑定用户角色，供 kubectl KUBECONFIG 使用
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin

# token
cat &gt; token.csv &lt;&lt; EOF
c47ffb939f5ca36231d9e3121a252940,jane,1
a1232123131231231231231231233112,cluster-admin,2,system:masters
b4564546555565444564564544545645,admin,3,system:masters
EOF

# apiserver bootstrap
cat &lt;&lt; EOF &gt; kube-apiserver.conf
KUBE_APISERVER_OPTS=&quot;--logtostderr=false \\
--v=5 \\
--etcd-servers=http://127.0.0.1:2379 \\
--bind-address=$LOCALIP \\
--secure-port=6443 \\
--advertise-address=$LOCALIP \\
--allow-privileged=true \\
--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\
--authorization-mode=RBAC,Node \\
--enable-bootstrap-token-auth=true \\
--token-auth-file=/opt/k8s/work/token.csv \\
--service-node-port-range=30000-32767 \\
--kubelet-client-certificate=/opt/k8s/work/server.pem \\
--kubelet-client-key=/opt/k8s/work/server-key.pem \\
--tls-cert-file=/opt/k8s/work/server.pem  \\
--tls-private-key-file=/opt/k8s/work/server-key.pem \\
--client-ca-file=/opt/k8s/work/ca.pem \\
--service-account-key-file=/opt/k8s/work/ca-key.pem \\
--service-account-issuer=api \\
--service-account-signing-key-file=/opt/k8s/work/server-key.pem \\
--requestheader-client-ca-file=/opt/k8s/work/ca.pem \\
--proxy-client-cert-file=/opt/k8s/work/server.pem \\
--proxy-client-key-file=/opt/k8s/work/server-key.pem \\
--requestheader-allowed-names=kubernetes \\
--requestheader-extra-headers-prefix=X-Remote-Extra- \\
--requestheader-group-headers=X-Remote-Group \\
--requestheader-username-headers=X-Remote-User \\
--enable-aggregator-routing=true \\
--audit-log-maxage=30 \\
--audit-log-maxbackup=3 \\
--audit-log-maxsize=100 \\
--audit-log-path=/opt/k8s/logs/k8s-audit.log&quot;
EOF

#------------------------------------------------------------

# 生成 service
#------------------------------------------------------------
cat &lt;&lt; EOF &gt; /lib/systemd/system/kube-apiserver.service
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/k8s/work/kube-apiserver.conf
ExecStart=/opt/k8s/kube-apiserver \$KUBE_APISERVER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl start kube-apiserver.service
#------------------------------------------------------------

# 生成 kubeconfig
#------------------------------------------------------------
mkdir -p /root/.kube/ &amp;&amp; cd /root/.kube
# 生成 kubectl 的 kubeconfig


kubectl config set-cluster kubernetes \
    --certificate-authority=/opt/k8s/work/ca.pem \
    --embed-certs=true \
    --server=https://$&#123;LOCALIP&#125;:6443 \
    --kubeconfig=config
    
kubectl config set-credentials cluster-admin \
    --client-certificate=/opt/k8s/work/admin.pem \
    --client-key=/opt/k8s/work/admin-key.pem \
    --embed-certs=true \
    --kubeconfig=config

kubectl config set-context default \
    --cluster=kubernetes \
    --user=cluster-admin \
    --kubeconfig=config

kubectl config use-context default --kubeconfig=config
kubectl get ns
#------------------------------------------------------------
</code></pre>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 Xiaoy
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;xiaoy
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
