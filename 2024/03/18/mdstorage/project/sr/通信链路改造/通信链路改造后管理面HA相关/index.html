
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>通信链路改造后管理面HA相关.md | Xiaoy</title>
    <meta name="author" content="xiaoy" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>XIAOY</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;XIAOY</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>通信链路改造后管理面HA相关.md</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/3/18
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/%E9%80%9A%E4%BF%A1%E9%93%BE%E8%B7%AF/" style="color: #ffa2c4">
                    通信链路
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h2 id="逻辑架构"><a href="#逻辑架构" class="headerlink" title="逻辑架构"></a>逻辑架构</h2><h3 id="引擎集群内信息同步"><a href="#引擎集群内信息同步" class="headerlink" title="引擎集群内信息同步"></a>引擎集群内信息同步</h3><h4 id="Host-机制"><a href="#Host-机制" class="headerlink" title="Host 机制"></a>Host 机制</h4><p>使用 <code>/etc/hosts</code> 对集群 host 进行维护</p>
<p>（安装时由引擎安装所填充）</p>
<pre><code>127.0.0.1 localhost

192.168.0.1 ouryun_m_node_1 ouryun_m 
192.168.0.2 ouryun_m_node_2 ouryun_m 
192.168.0.3 ouryun_m_node_3 ouryun_m 
</code></pre>
<p>kubernetes 的客户端会依据 ouryun_m 自动找到 Apiserver 服务端</p>
<h4 id="Etcd-集群机制"><a href="#Etcd-集群机制" class="headerlink" title="Etcd 集群机制"></a>Etcd 集群机制</h4><ul>
<li>etcd 通过 Hostname 进行集群组建</li>
<li>组建好的 etcd 集群会内部通信，保证集群内部数据一致性</li>
</ul>
<h4 id="Apiserver-机制"><a href="#Apiserver-机制" class="headerlink" title="Apiserver 机制"></a>Apiserver 机制</h4><ul>
<li>Apiserver 连接本地的 etcd，利用 etcd 的数据一致性保证 Apiserver 之间的数据一致</li>
<li>向引擎所有节点的组件提供服务，并提供认证鉴权</li>
<li>Apiserver 签发证书时不需要关注自己的 ip ，而是为多个 hostname 申请即可，提高了灵活性和可维护性（为后续引擎修改 ip 做铺垫）</li>
</ul>
<h4 id="引擎集群内部组件通过-Apiserver-进行组件间信息同步（operator-开发模型）"><a href="#引擎集群内部组件通过-Apiserver-进行组件间信息同步（operator-开发模型）" class="headerlink" title="引擎集群内部组件通过 Apiserver 进行组件间信息同步（operator 开发模型）"></a>引擎集群内部组件通过 Apiserver 进行组件间信息同步（operator 开发模型）</h4><p>Apiserver 的客户端 client-go 已提供通过 hostname 进行集群的服务发现机制，确保了客户端总是可以找到提供特定服务的 Apiserver。</p>
<pre><code class="mermaid">---
title: 通信链路改造后管理面HA相关
---
graph TB
    subgraph Sc[总控]
        sc_core[sc core]
        sc[sc]
    end

    subgraph Se
        subgraph M_Group[管理面集群]
            subgraph M_Node1[管理节点]
                webserver1[webserver]
                apiserver1[Apiserver]
                etcd1[Etcd]
                webserver1 --&gt;|127.0.0.1| apiserver1 --&gt;|127.0.0.1| etcd1
            end
            subgraph M_Node2[管理节点]
                webserver2[webserver]
                apiserver2[Apiserver]
                etcd2[Etcd]
                webserver2 --&gt;|127.0.0.1| apiserver2 --&gt;|127.0.0.1| etcd2
            end
            subgraph M_Node3[管理节点]
                webserver3[webserver]
                apiserver3[Apiserver]
                etcd3[Etcd]
                webserver3 --&gt;|127.0.0.1| apiserver3 --&gt;|127.0.0.1| etcd3
            end
            
            etcd1 &amp; etcd2 &lt;--&gt; etcd3
            etcd2 &lt;---&gt; etcd1
        end
        subgraph S_Group[调度节点集群]
            webserver4[webserver]
            webserver5[webserver]
        end
        subgraph W_Group[工作节点集群]
            webserver6[webserver]
            webserver7[webserver]
            webserver8[webserver]
        end
        webserver4 &amp; webserver5 &amp; webserver6 &amp; webserver7 &amp; webserver8 ---&gt;|host: ouryun_m| apiserver1
%%		webserver4 --&gt; webserver1
        
    end
    
    sc &lt;--&gt;sc_core
    webserver1 &amp; webserver2 &amp; webserver3 &amp; webserver4 &amp; webserver5 &amp; webserver6 &amp; webserver7 &amp; webserver8 ====&gt;|channel| sc_core
    
    style Sc fill:#87CEFA
    style Se fill:#708090
    
    linkStyle 9,10,11,12,13 stroke:#FFA07A,stroke-width:2px,color:green;
    linkStyle 6,7,8 stroke:#FFD700,stroke-width:3px,color:green;
    linkStyle 1,3,5 stroke:#32CD32,stroke-width:2px,color:yellow;
    linkStyle 14,15,16,17,18,19,20,21,22 stroke:#FF6347,stroke-width:8px,color:green;
</code></pre>
<h3 id="总控-引擎通信"><a href="#总控-引擎通信" class="headerlink" title="总控-引擎通信"></a>总控-引擎通信</h3><h4 id="总控-管理面通信"><a href="#总控-管理面通信" class="headerlink" title="总控-管理面通信"></a>总控-管理面通信</h4><h5 id="webserver-服务注册机制"><a href="#webserver-服务注册机制" class="headerlink" title="webserver 服务注册机制"></a>webserver 服务注册机制</h5><p>webserver 启动时会向 sc-core 注册本组件信息，其中包括本节点角色(M)、引擎序列号、引擎节点ID 等信息</p>
<h5 id="sc-core-负载均衡机制"><a href="#sc-core-负载均衡机制" class="headerlink" title="sc-core 负载均衡机制"></a>sc-core 负载均衡机制</h5><p>sc-core 在转发总控到引擎管理面流量时，指定对应引擎和节点角色，可以通过已注册的引擎的 webserver 负载均衡一个可用的引擎管理面中的 webserver 进行处理。</p>
<h4 id="总控-任意节点-webserver-通信"><a href="#总控-任意节点-webserver-通信" class="headerlink" title="总控-任意节点 webserver 通信"></a>总控-任意节点 webserver 通信</h4><p>sc-core 在转发总控到任意引擎节点时，指定对应引擎和节点ID，可以通过注册信息，转发到指定节点的 webserver 中进行处理。</p>
<h2 id="物理架构"><a href="#物理架构" class="headerlink" title="物理架构"></a>物理架构</h2><h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><h3 id="引擎-webserver-sc-core-注册流程"><a href="#引擎-webserver-sc-core-注册流程" class="headerlink" title="引擎 webserver -&gt; sc-core 注册流程"></a>引擎 webserver -&gt; sc-core 注册流程</h3><h3 id="引擎安装-webserver-流程"><a href="#引擎安装-webserver-流程" class="headerlink" title="引擎安装 webserver 流程"></a>引擎安装 webserver 流程</h3><ul>
<li>修改 hosts</li>
<li>安装 webserver</li>
<li>配置启动参数</li>
<li>apiserver、etcd 安装逻辑</li>
</ul>
<h3 id="sc-向管理面-webserver-通信"><a href="#sc-向管理面-webserver-通信" class="headerlink" title="sc 向管理面 webserver 通信"></a>sc 向管理面 webserver 通信</h3><h3 id="调度节点、工作节点组件访问管理面组件"><a href="#调度节点、工作节点组件访问管理面组件" class="headerlink" title="调度节点、工作节点组件访问管理面组件"></a>调度节点、工作节点组件访问管理面组件</h3><h2 id="异常场景"><a href="#异常场景" class="headerlink" title="异常场景"></a>异常场景</h2>
    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 Xiaoy
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;xiaoy
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
