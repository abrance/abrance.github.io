
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>软件说明文档.md | Xiaoy</title>
    <meta name="author" content="xiaoy" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>XIAOY</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;XIAOY</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>软件说明文档.md</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/3/20
        </span>
        
        <span class="category">
            <a href="/categories/project/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                project
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/%E8%BD%AF%E4%BB%B6%E8%AF%B4%E6%98%8E/" style="color: #ff7d73">
                    软件说明
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h1 id="软件说明文档"><a href="#软件说明文档" class="headerlink" title="软件说明文档"></a>软件说明文档</h1><h2 id="软件名"><a href="#软件名" class="headerlink" title="软件名"></a>软件名</h2><p><code>cust</code> </p>
<p>C程序转换器</p>
<h2 id="功能摘要"><a href="#功能摘要" class="headerlink" title="功能摘要"></a>功能摘要</h2><ol>
<li>提供命令行工具将目标 C&#x2F;C++ 语言源码，转换为相应 Rust 语言代码</li>
</ol>
<h2 id="软件分类"><a href="#软件分类" class="headerlink" title="软件分类"></a>软件分类</h2><p>linux CLI 工具</p>
<h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><p>C: 指 C&#x2F;C++ 语言，后面简化称为 C</p>
<p>src code: 源语言，指待转换的语言，本次的指 C</p>
<p>AST: 抽象语法树</p>
<p>IR: Intermediate Representation 中间表示，与语言无关，硬件无关，容易进行优化，多级表示，丰简由人，这适合在 C to Rust 应用中使用。</p>
<h2 id="应用领域"><a href="#应用领域" class="headerlink" title="应用领域"></a>应用领域</h2><p>对于如军工、医疗、航天、核能领域，需要一种运行效率、内存安全、稳定性方面有严格要求的语言进行应用程序实现，当已有的 C&#x2F;C++ 程序满足不了这些要求时，就需要将现有的 C&#x2F;C++ 程序、工具库转换为可用的 Rust 程序。<code>cust</code>即可适用于此场景。</p>
<h2 id="开源许可证类型"><a href="#开源许可证类型" class="headerlink" title="开源许可证类型"></a>开源许可证类型</h2><p>GPL v3</p>
<h2 id="作品概述"><a href="#作品概述" class="headerlink" title="作品概述"></a>作品概述</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><ul>
<li>目标：C&#x2F;C++ 程序转换为 Rust 程序</li>
</ul>
<h3 id="作品特点"><a href="#作品特点" class="headerlink" title="作品特点"></a>作品特点</h3><ul>
<li><p>结合编译原理和现有的 AI 大模型各自优势，将 C&#x2F;C++ 程序转换为可用的 Rust 程序</p>
</li>
<li><p>利用编译原理，src code （本次工具中为 C）转换 AST ， AST 再成与 IR （中间语言的形式），再将 IR 语言转换为 Rust 语言，这样做的好处是可以利用这一思路最大程度复用代码，如 src code -&gt;  IR 这部分代码可复用于转换为其他目标语言，而 IR  -&gt; Rust code 部分代码可复用到不同的 src code -&gt; Rust code。</p>
<p>同时，C to Rust 中采用 IR 的方式有诸多优势：</p>
<ul>
<li><strong>硬件无关</strong>：IR 设计成独立于任何特定的硬件或指令集架构（ISA），适用于多种硬件平台，也就是说转义出来的目标语言天然跨平台。</li>
<li><strong>容易进行优化</strong>：IR 通常设计得使得对代码进行分析和优化变得更加容易，开发路径也相对简单，易进行迭代开发。</li>
<li><strong>多级表示</strong>：可使用多级别的 IR，每个级别提供不同的抽象程度。</li>
</ul>
</li>
</ul>
<h3 id="运行环境和运行步骤"><a href="#运行环境和运行步骤" class="headerlink" title="运行环境和运行步骤"></a>运行环境和运行步骤</h3><h4 id="编译环境"><a href="#编译环境" class="headerlink" title="编译环境"></a>编译环境</h4><p>clang llvm 环境，支持 Linux ，不支持 windows</p>
<p>rust cargo 环境</p>
<h4 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h4><p>clang llvm 环境，支持 Linux ，不支持 windows</p>
<p>使用 ai 优化需要能连上通义的接口（外网）</p>
<h3 id="功能描述"><a href="#功能描述" class="headerlink" title="功能描述"></a>功能描述</h3><ul>
<li><p>完全使用语义解析进行 C To Rust 转换</p>
</li>
<li><p>采用语义解析 C To Rust、将上下文和结果输入到 AI 大模型进行语义检查和最后的优化。 </p>
</li>
<li><p>C 语言代码排错</p>
<ul>
<li><strong>语法错误</strong>：这是编程中最常见的错误类型，如缺少分号、括号不匹配、错误的关键字使用等。如果代码中存在语法错误，编译器将无法正确理解代码，从而无法继续编译过程。</li>
<li><strong>类型错误</strong>：类型错误发生在对变量或表达式进行了不允许或预期之外的操作时，例如将整数类型赋值给字符类型变量，或对字符串执行数学运算。</li>
<li><strong>声明和定义错误</strong>：包括变量或函数未声明、重复声明、缺少必要的头文件导入等。</li>
<li><strong>作用域问题</strong>：尝试访问仅在另一个作用域中定义的变量或函数时，会发生作用域错误。</li>
<li><strong>链接错误</strong>：如果代码中存在对未定义或未实现的外部函数或变量的引用，进行完整编译过程时会被识别为链接错误。</li>
<li><strong>警告</strong>：警告不会阻止代码的编译，但它们指出了可能导致运行时错误的代码实践，如可能的变量未初始化、未使用的变量、潜在的类型转换问题等</li>
<li><strong>内存访问错误</strong>：会静态检测到潜在的内存访问问题，如数组越界访问、解引用空指针等，尽管许多此类错误需要运行时检查来发现。</li>
<li><strong>优化建议</strong>：提出代码优化的建议，以改善性能或减少内存消耗，虽然这通常不会影响编译过程的成功与否。</li>
<li><strong>标准遵从性</strong>：会检查代码是否遵循了选定的 C 语言标准（如 C99、C11 等），包括对废弃特性的使用警告等。</li>
</ul>
</li>
<li><p>支持文件输入和字符串输入代码</p>
<ul>
<li><p>–file file_path 输入文件输入代码</p>
</li>
<li><p>–code “” 字符串输入代码</p>
<pre><code class="bash">./cust -c &quot;$(cat &lt;&lt;EOF
#include &lt;iostream&gt;
#include &lt;cstdarg&gt;

void print_values(int n, ...) &#123;
    va_list vl;
    va_start(vl, n);
    for (int i = 0; i &lt; n; i++) &#123;
        int value = va_arg(vl, int);
        std::cout &lt;&lt; &quot;Value: &quot; &lt;&lt; value &lt;&lt; &quot;\\n&quot;;
    &#125;
    va_end(vl);
&#125;
int main() &#123;
    print_values(3, 10, 20, 30);
    return 0;
&#125;
EOF
)&quot;
</code></pre>
</li>
</ul>
</li>
<li><p>支持输出到 stdout 和文件</p>
</li>
<li><p>-o stdout | dst_file_path 输出定向到标准输出或目标文件中</p>
</li>
</ul>
<h3 id="体系架构"><a href="#体系架构" class="headerlink" title="体系架构"></a>体系架构</h3><h4 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h4><pre><code class="mermaid">graph TB;
    符号表
    src[字符流]:::no_border
    an1[词法分析器]
    an2[语法分析]
    an3[语义分析]
    code_gen1[中间代码生成器]
    code_opt[语言无关代码优化器]
    code_gen2[代码生成器]
    code_gen3[机器相关代码优化器]
    dst[目标语言]:::no_border
    src --&gt; an1 --&gt;|符号流| an2 --&gt;|语法树| an3 --&gt;|语法树| code_gen1 --&gt;|中间表示形式| code_opt --&gt;|中间表示形式| code_gen2 --&gt;|目标机器语言| code_gen3 --&gt; dst
    
    
    classDef no_border fill:transparent, stroke:transparent ;
</code></pre>
<h5 id="解析对象和流程"><a href="#解析对象和流程" class="headerlink" title="解析对象和流程"></a>解析对象和流程</h5><pre><code class="mermaid">---
title: 解析对象和流程
---

graph TB;
    src[用户输入]:::no_border
    
    subgraph Cust[cust 程序]
        an1[获取用户输入 file is-ai-opt output]
        an2[检查C代码正确性]
        an3[语法、语义、词法分析]
        code_gen1[中间代码生成器]
        code_opt[中间代码优化器]
        code_gen2[Rust 代码生成器]
        code_gen3[Rust 代码优化器]
        code_opt2[ai 优化]
        dst[Rust 代码输出]:::no_border
    end
    src --&gt; an1 --&gt;|获取待解析的C代码| an2 --&gt;|待解析的C代码| an3 --&gt;|语法树 AST| code_gen1 --&gt;|中间表示形式 IR| code_opt --&gt;|中间表示形式 IR| code_gen2 --&gt;|Rust 语言| code_gen3 --&gt; dst
    an1 &amp; an2 &amp; an3 &amp; code_gen1 &amp; code_opt &amp; code_gen2 &amp; code_gen3 ---&gt; code_opt2 ---&gt; dst
    classDef no_border fill:transparent, stroke:transparent ;
</code></pre>
<h4 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h4><pre><code class="mermaid">sequenceDiagram
    participant UserInput as 用户输入
    participant CustProgram as cust 程序
    participant CCheck as 检查C代码正确性
    participant Analysis as 语法、语义、词法分析
    participant IRGen as 中间代码生成器
    participant IROpt as 中间代码优化器
    participant RustCodeGen as Rust 代码生成器
    participant RustOpt as Rust 代码优化器
    participant AIOpt as ai 优化
    participant RustOutput as Rust 代码输出

    UserInput-&gt;&gt;CustProgram: 获取用户输入
    CustProgram-&gt;&gt;CCheck: 获取待解析的C代码
    CCheck-&gt;&gt;Analysis: 待解析的C代码
    Analysis-&gt;&gt;IRGen: 语法树 AST
    IRGen-&gt;&gt;IROpt: 中间表示形式 IR
    IROpt-&gt;&gt;RustCodeGen: 中间表示形式 IR
    RustCodeGen-&gt;&gt;RustOpt: Rust 语言
    RustOpt-&gt;&gt;AIOpt: Rust 代码
    AIOpt-&gt;&gt;RustOutput: 优化后的Rust代码
</code></pre>
<h4 id="输入和输出"><a href="#输入和输出" class="headerlink" title="输入和输出"></a>输入和输出</h4><ul>
<li>字符输入</li>
</ul>
<p><img src="http://119.91.145.27:12799/api/public/dl/p8KdAUHH/image-20240326225550130.png" alt="image-20240326225550130"></p>
<ul>
<li>代码文件输入</li>
</ul>
<p><img src="http://119.91.145.27:12799/api/public/dl/p8KdAUHH/image-20240326225753595.png" alt="image-20240326225753595"></p>
<ul>
<li>输出<ul>
<li>代码检查</li>
<li>转换代码</li>
<li>AI 优化代码</li>
</ul>
</li>
</ul>
<p><img src="http://119.91.145.27:12799/api/public/dl/p8KdAUHH/image-20240326225616707.png" alt="image-20240326225616707"></p>
<p><img src="http://119.91.145.27:12799/api/public/dl/p8KdAUHH/image-20240326225824678.png" alt="image-20240326225824678"></p>
<h4 id="关键技术点"><a href="#关键技术点" class="headerlink" title="关键技术点"></a>关键技术点</h4><p><code>clang libclang llvm</code></p>
<p>Rust crate <code> clang clang-sys syn</code> </p>
<p>llvm IR</p>
<h4 id="逻辑架构"><a href="#逻辑架构" class="headerlink" title="逻辑架构"></a>逻辑架构</h4><ul>
<li>代码输入</li>
<li>clang-sys 词法、语法、语义解析</li>
<li>clang AST 建立</li>
<li>IR 结构生成器</li>
<li>Rust 翻译规则生成</li>
<li>Rust 代码生成</li>
<li>Rust 代码优化</li>
<li>AI 检查、优化</li>
</ul>
<h4 id="部署要求"><a href="#部署要求" class="headerlink" title="部署要求"></a>部署要求</h4><p>llvm clang 库安装</p>
<pre><code class="bash"># ubuntu22.04
sudo apt-get update
sudo apt-get install llvm clang
</code></pre>
<p>Rust cargo 基础开发环境、能访问外网拉取 crate。</p>
<p>如果使用 ai 优化功能，需要能连接通义千问。本项目代码中内置 api key</p>
<h2 id="问题、解决思路"><a href="#问题、解决思路" class="headerlink" title="问题、解决思路"></a>问题、解决思路</h2><ul>
<li>入参 int n … 语法翻译问题<ul>
<li>通过 <code>AST</code> 中解析出参数中是否有此语法，如果有，则在 IR 中做出记录，在 IR to Rust 中将其转换为 <code>Vec&lt;T&gt;</code> , 并在之后的 Function body 逻辑处理中，将 C 中对 n 的处理，转换为 Rust 对 Vec<T> n  的处理。在上下文中记录此函数声明和此参数上下文。</li>
</ul>
</li>
<li>获取 for 循环中的 condition 的 operator 思路<ul>
<li><strong>计算左操作数的偏移量（<code>left_offset</code>）</strong>：<ul>
<li>首先，获取左操作数实体（<code>entity.get_child(0)</code>），假设为二元操作的第一个子实体。</li>
<li>使用 <code>.map</code> 遍历左操作数的子实体（这里实际上只有一个），获取每个子实体的源代码范围（<code>get_range()</code>），然后对这个范围内的标记（<code>tokenize()</code>）进行计数（<code>.len()</code>），以确定左操作数占用了多少个标记。</li>
<li>通过 <code>.fold</code> 将这些标记数量累加起来，得到 <code>left_offset</code>，即左操作数结束的位置（以标记计数为单位）。</li>
</ul>
</li>
<li><strong>获取整个二元操作的标记</strong>：<ul>
<li>通过 <code>entity.get_range().and_then(|r| Some(r.tokenize()))</code> 获取表示整个二元操作的 <code>Entity</code> 的源代码范围，并将这个范围内的内容分割成标记。</li>
</ul>
</li>
<li><strong>提取操作符</strong>：<ul>
<li>使用左操作数的偏移量 <code>left_offset</code> 作为索引，从整个二元操作的标记列表中提取操作符。因为左操作数后面紧跟的标记应该就是操作符本身。</li>
</ul>
</li>
<li><strong>返回操作符的拼写</strong>：<ul>
<li>通过 <code>get_spelling()</code> 方法获取操作符标记的文本表示，然后将其作为 <code>Some</code> 值返回。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="产品"><a href="#产品" class="headerlink" title="产品"></a>产品</h3><ol>
<li><strong>创新性结合</strong>: 利用编译原理和现有的AI技术的优势，提供一个高效且可靠的C&#x2F;C++到Rust的代码转换工具。</li>
<li><strong>高度复用设计</strong>: 通过先将C代码转换为中间表示（IR），然后再将IR转换为Rust代码的策略，增强了代码的可复用性，同时也支持将IR转换为其他目标语言。</li>
<li><strong>硬件和平台无关</strong>: IR设计独立于任何特定的硬件或指令集，使得转换出来的Rust代码能够跨平台使用。</li>
<li><strong>易于优化</strong>: IR层面的设计便于代码分析和优化，有助于生成性能更高、内存使用更优的Rust代码。同时后期迭代可以有多级的IR，做到职责单一、程序便于维护迭代。</li>
<li><strong>支持广泛的错误排查和优化</strong>: 包括语法错误、类型错误、声明和定义错误、作用域问题、链接错误、内存访问错误等，以及提供代码优化建议。</li>
<li><strong>灵活的输入输出</strong>: 支持文件输入和字符串输入，以及输出到标准输出或文件，提高了工具的使用灵活性。</li>
<li><strong>开源许可</strong>: 采用GPL v3开源许可证，促进了社区的贡献和软件的持续改进。</li>
</ol>
<h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><strong>我的演讲结束，谢谢大家，具体的实现可以看源码 和 演示视频</strong></p>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 Xiaoy
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;xiaoy
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
